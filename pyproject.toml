# ==== pytest ====
[tool.pytest.ini_options]
minversion = "6.0"
addopts = "--ds=config.settings.test --reuse-db --import-mode=importlib"
python_files = [
    "tests.py",
    "test_*.py",
]

# ==== Coverage ====
[tool.coverage.run]
include = ["footycollect/**"]
omit = ["*/migrations/*", "*/tests/*"]
plugins = ["django_coverage_plugin"]

# ==== mypy ====
[tool.mypy]
python_version = "3.12"
check_untyped_defs = true
ignore_missing_imports = true
warn_unused_ignores = true
warn_redundant_casts = true
warn_unused_configs = true
plugins = [
    "mypy_django_plugin.main",
    "mypy_drf_plugin.main",
]

[[tool.mypy.overrides]]
# Django migrations should not produce any errors:
module = "*.migrations.*"
ignore_errors = true

[tool.django-stubs]
django_settings_module = "config.settings.test"

# ==== djLint ====
[tool.djlint]
blank_line_after_tag = "load,extends"
close_void_tags = true
format_css = true
# NOTE: format_js disabled because it breaks Django template tags inside JavaScript
# e.g., {{ name }} gets reformatted to { { name } } which is invalid
format_js = false
# TODO: remove T002 when fixed https://github.com/djlint/djLint/issues/687
# H021: Inline styles are necessary for Bootstrap Icons sizing (no utility classes available)
ignore = "H006,H021,H030,H031,T002"
include = "H017,H035"
indent = 2
max_line_length = 119
profile = "django"

[tool.djlint.css]
indent_size = 2

[tool.djlint.js]
indent_size = 2

[tool.ruff]
target-version = "py312"
line-length = 119
# Config is resolved from project root when running: ruff check . (or ruff check path/to/project)
# Exclude a variety of commonly ignored directories.
extend-exclude = [
    "*/migrations/*.py",
    "staticfiles/*",
    "*/templates/*",
    "venv",
    ".venv",
]

[tool.ruff.lint]
select = [
  "F",
  "E",
  "W",
  "C90",
  "I",
  "N",
  "UP",
  "YTT",
  # "ANN", # flake8-annotations: we should support this in the future but 100+ errors atm
  "ASYNC",
  "S",
  "BLE",
  "FBT",
  "B",
  "A",
  "COM",
  "C4",
  "DTZ",
  "T10",
  "DJ",
  "EM",
  "EXE",
  "FA",
  'ISC',
  "ICN",
  "G",
  'INP',
  'PIE',
  "T20",
  'PYI',
  'PT',
  "Q",
  "RSE",
  "RET",
  "SLF",
  "SLOT",
  "SIM",
  "TID",
  "TCH",
  "INT",
  # "ARG", # Unused function argument
  "PTH",
  "ERA",
  "PD",
  "PGH",
  "PL",
  "TRY",
  "FLY",
  # "NPY",
  # "AIR",
  "PERF",
  # "FURB",
  # "LOG",
  "RUF",
]
ignore = [
  "S101", # Use of assert detected https://docs.astral.sh/ruff/rules/assert/
  "RUF012", # Mutable class attributes should be annotated with `typing.ClassVar`
  "SIM102", # sometimes it's better to nest
  "COM812", # Trailing comma missing - conflicts with ruff formatter
  "ISC001", # Implicit string concatenation - conflicts with ruff formatter
  "PLC0415", # Import outside top-level - common in Django (lazy/circular imports)
  "PGH004", # Use specific rule codes in noqa - many files use blanket noqa
  "UP038", # isinstance(x, (A, B)) -> A|B; can make code slow, rule removed in newer ruff
]

[tool.ruff.lint.isort]
# force-single-line = true

[tool.ruff.lint.flake8-self]
# Ignore access to _meta since it's a recognized Django API
ignore-names = ["_meta"]

[tool.ruff.lint.per-file-ignores]
# Ignore SLF001, S105, S106 in all test files
"**/tests/**/*.py" = ["SLF001", "S105", "S106"]
"**/test_*.py" = ["SLF001", "S105", "S106"]
# Ignore F403 and S104 in configuration files
"config/settings/*.py" = ["F403"]
"config/settings/local.py" = ["S104"]
# Ignore PD011 in test_services files
"**/tests/test_services.py" = ["PD011"]
"footycollect/collection/tests/test_item_service.py" = ["PD011"]
"footycollect/collection/tests/test_photo_service.py" = ["PD011"]
# Ignore PT009 (unittest-style assertions) in E2E test files
# Ignore style issues that are acceptable in complex E2E tests
"footycollect/collection/tests/test_e2e_selenium.py" = [
    "PT009",
    "FBT003",
    "N812",
    "BLE001",
    "PLR0915",
]
"footycollect/collection/tests/test_e2e_item_creation.py" = [
    "PT009",
    "FBT003",
]
# Ignore complexity warnings in management commands (acceptable for CLI tools)
"footycollect/collection/management/commands/*.py" = [
    "C901",
    "PLR0912",
    "PLR0913",
]
# Ignore complexity warnings in checks (acceptable for validation logic)
"config/checks.py" = [
    "A004",
    "BLE001",
    "C901",
    "PLR0912",
]
"config/tests/test_checks.py" = ["A004"]
"config/middleware.py" = [
    "BLE001",
    "FBT003",
    "PLR2004",
    "S110",
    "S324",
]
"config/settings/base.py" = ["PTH110", "PTH120", "PLW2901"]
"deploy/patch-csp-server.py" = ["EXE001", "PTH123", "T201"]
"deploy/patch-storage-domain-server.py" = ["EXE001", "PTH123", "T201"]
"footycollect/collection/management/commands/backup_db.py" = [
    "B904",
    "EM101",
    "EM102",
    "S603",
    "TRY003",
]
"footycollect/collection/management/commands/restore_db.py" = [
    "BLE001",
    "B904",
    "EM101",
    "EM102",
    "PTH110",
    "PTH123",
    "S603",
    "S608",
    "TRY003",
]
"footycollect/collection/management/commands/cleanup_orphans.py" = ["PLR0915", "PLR2004"]
"footycollect/collection/management/commands/create_demo_user.py" = ["BLE001"]
"footycollect/collection/services/feed_service.py" = ["PLR0912"]
"footycollect/collection/services/service_registry.py" = ["PYI034"]
"footycollect/collection/tasks.py" = ["SIM115"]
"footycollect/collection/tests/test_views/test_jersey_views.py" = ["BLE001"]
"footycollect/collection/views/admin_actions.py" = ["PLR2004"]
"footycollect/collection/views/photo_views.py" = ["PLR2004"]

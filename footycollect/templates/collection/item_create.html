{% extends "base.html" %}

{% load i18n static %}
{% load crispy_forms_tags %}

{% block css %}
  {{ block.super }}
  {{ form.media.css }}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
        rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
        rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flag-icons@7.3.2/css/flag-icons.min.css"
        rel="stylesheet" />
  <style>
    .fi {
      margin-right: 8px;
      border-radius: 3px;
      width: 1.3em;
      height: 1em;
      box-shadow: 0 0 1px rgba(0, 0, 0, 0.2);
      vertical-align: middle;
    }

    .select2-results__option {
      line-height: 1.8em;
    }

    .select2-selection__rendered .fi {
      margin-right: 5px;
      vertical-align: -0.1em;
    }

    /* Styles for color selectors */
    .color-swatch {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 5px;
      border-radius: 3px;
      border: 1px solid #ddd;
      vertical-align: middle;
    }

    /* Styles for design selector */
    .design-option {
      display: flex;
      align-items: center;
      padding: 5px;
    }

    .design-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
  </style>
{% endblock css %}
{% block content %}
  {{ form.media }}
  <div class="container py-4">
    <h1>{% trans "Add New Item" %}</h1>
    {% if messages %}
      <div class="messages">
        {% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}
      </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data" id="item-form">
      {% csrf_token %}
      <!-- Item Details -->
      <div class="card mb-4">
        <div class="card-body">
          <!-- Cotton components for colors and design -->
          <div class="row mb-3">
            <div class="col-md-6">
              <c-color-selector name="main_color" label="{% trans 'Main Color' %}" data-selected="{{ form.main_color.value|default:'' }}" :color_choices="color_choices">
              </c-color-selector>
            </div>
            <div class="col-md-6">
              <c-color-selector name="secondary_colors" label="{% trans 'Secondary Colors' %}" data-multiple="true" data-selected="{{ form.secondary_colors.value|default:'' }}" :color_choices="color_choices">
              </c-color-selector>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <c-design-selector name="design" label="{% trans 'Design Pattern' %}" data-selected="{{ form.design.value|default:'' }}" :design_choices="design_choices">
              </c-design-selector>
            </div>
          </div>
          {{ form|crispy }}
        </div>
      </div>
      <!-- Photo Manager -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">{% trans "Photos" %}</h5>
        </div>
        <div class="card-body">
          <c-collection.photo_manager></c-collection.photo_manager>
        </div>
      </div>
      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="submit" class="btn btn-primary">{% trans "Create Item" %}</button>
      </div>
    </form>
  </div>
{% endblock content %}
{% block extra_js %}
  {{ form.media.js }}
  <script>
    $(document).ready(function() {
      // Initialization of Select2 for country
      $('#id_country_code').select2({
        ajax: {
          url: "{% url 'core:country-autocomplete' %}",
          dataType: 'json'
        }
      });

      // Initialization for color selectors with FKAPI data
      $('[data-colors][data-fkapi]').each(function() {
        const $select = $(this);
        $.ajax({
          url: '/api/colors/',
          dataType: 'json',
          success: function(data) {
            // Populate the selector with data from the API
            // The implementation depends on the structure of the FKAPI data
            $select.select2({
              templateResult: formatColorOption,
              templateSelection: formatColorSelection,
              theme: 'bootstrap-5'
            });
          }
        });
      });

      // Function to format color options
      function formatColorOption(color) {
        if (!color.id) return color.text;
        return $(`<span><span class="color-swatch" style="background-color: ${color.code};"></span> ${color.text}</span>`);
      }

      // Function to format color selection
      function formatColorSelection(color) {
        if (!color.id) return color.text;
        return $(`<span><span class="color-swatch" style="background-color: ${color.code};"></span> ${color.text}</span>`);
      }
    });
  </script>
{% endblock extra_js %}

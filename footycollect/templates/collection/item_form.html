{% extends "base.html" %}

{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block css %}
  {{ block.super }}
  {{ form.media.css }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <style>
    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--fc-secondary);
      border: 1px solid var(--fc-border);
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: var(--fc-foreground);
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: hsla(180, 85%, 40%, 1);
      border-color: hsla(180, 85%, 40%, 1);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(24px);
      background-color: white;
    }

    .toggle-switch input:focus+.toggle-slider {
      box-shadow: 0 0 0 3px hsla(180, 85%, 40%, 0.25);
    }

    /* Change blue buttons to teal */
    .btn-primary {
      background-color: hsla(180, 85%, 40%, 1) !important;
      border-color: hsla(180, 85%, 40%, 1) !important;
    }

    .btn-primary:hover {
      background-color: hsla(180, 85%, 35%, 1) !important;
      border-color: hsla(180, 85%, 35%, 1) !important;
    }

    .btn-outline-primary {
      border-color: hsla(180, 85%, 40%, 1) !important;
      color: hsla(180, 85%, 40%, 1) !important;
    }

    .btn-outline-primary:hover {
      background-color: hsla(180, 85%, 40%, 0.1) !important;
      border-color: hsla(180, 85%, 40%, 1) !important;
      color: hsla(180, 85%, 40%, 1) !important;
    }

    /* Form inputs dark theme */
    .form-control,
    .form-select {
      background-color: var(--fc-secondary) !important;
      border: 1px solid var(--fc-border) !important;
      color: var(--fc-foreground) !important;
    }

    .form-control:focus,
    .form-select:focus {
      background-color: var(--fc-secondary) !important;
      border-color: hsla(180, 85%, 40%, 1) !important;
      color: var(--fc-foreground) !important;
      box-shadow: 0 0 0 0.2rem hsla(180, 85%, 40%, 0.25) !important;
    }

    .form-label {
      color: var(--fc-muted-foreground) !important;
      font-size: 0.875rem !important;
    }
  </style>
{% endblock css %}
{% block content %}
  {{ form.media }}
  <div class="fc-container-centered">
    <h2 class="mb-4 fc-title-large">{% trans "Add Jersey (Manual)" %}</h2>
    {% if help_text %}
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>{{ help_text }}
      </div>
    {% endif %}
    {% if messages %}
      <div class="messages">
        {% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}
      </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data" id="jersey-form">
      {% csrf_token %}
      <!-- Basic Information -->
      <div class="fc-card mb-4">
        <div class="fc-card-header-small">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Basic Information" %}</h5>
        </div>
        <div class="fc-card-body-flex">
          <div class="row">
            <div class="col-md-6 mb-3">{{ form.name|as_crispy_field }}</div>
            <div class="col-md-6 mb-3">{{ form.size|as_crispy_field }}</div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <c-autocomplete-search name="brand" label="{{ label_brand }}" required="true" api_endpoint="brands" help_text="{{ help_brand }}">
              </c-autocomplete-search>
              {{ form.brand }}
              {{ form.brand_name }}
            </div>
            <div class="col-md-4 mb-3">
              <c-autocomplete-search name="club" label="{{ label_club }}" required="false" api_endpoint="clubs" help_text="{{ help_club }}">
              </c-autocomplete-search>
              {{ form.club }}
            </div>
            <div class="col-md-4 mb-3">
              <c-autocomplete-search name="season" label="{{ label_season }}" required="false" api_endpoint="seasons" help_text="{{ help_season }}">
              </c-autocomplete-search>
              {{ form.season }}
              {{ form.season_name }}
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">
              <c-autocomplete-search name="competitions" label="{{ label_competitions }}" required="false" multiple="true" api_endpoint="competitions" help_text="{{ help_competitions }}">
              </c-autocomplete-search>
              {{ form.competitions }}
              {{ form.competition_name }}
            </div>
          </div>
        </div>
      </div>
      <!-- Appearance -->
      <div class="fc-card mb-4">
        <div class="fc-card-header">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Appearance" %}</h5>
        </div>
        <div class="fc-card-body-flex">
          <div class="row mb-3">
            <div class="col-md-6" id="div_id_main_color">
              <c-color-selector name="main_color" label="{% trans 'Main Color' %}" data-selected="{{ form.main_color.value|default:'' }}" :color_choices="{{ color_choices|safe }}">
              </c-color-selector>
            </div>
            <div class="col-md-6" id="div_id_secondary_colors">
              <c-color-selector name="secondary_colors" label="{% trans 'Secondary Colors' %}" data-multiple="true" data-selected="{{ form.secondary_colors.value|default:'' }}" :color_choices="{{ color_choices|safe }}">
              </c-color-selector>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12" id="div_id_design">
              <c-design-selector name="design" label="{% trans 'Design Pattern' %}" data-selected="{{ form.design.value|default:'' }}" :design_choices="{{ design_choices|safe }}">
              </c-design-selector>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6 mb-3">{{ form.country_code|as_crispy_field }}</div>
          </div>
        </div>
      </div>
      <!-- Condition & Details -->
      <div class="fc-card mb-4">
        <div class="fc-card-header">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Condition & Details" %}</h5>
        </div>
        <div class="fc-card-body-flex">
          <div class="row">
            <div class="col-md-6 mb-3">{{ form.condition|as_crispy_field }}</div>
            <div class="col-md-6 mb-3">{{ form.detailed_condition|as_crispy_field }}</div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">{{ form.description|as_crispy_field }}</div>
          </div>
        </div>
      </div>
      <!-- Jersey-Specific Details -->
      <div class="fc-card mb-4" x-data="jerseyFormManual">
        <div class="fc-card-header">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Jersey-Specific Details" %}</h5>
        </div>
        <div class="fc-card-body-flex">
          <!-- Version Toggle: Fan vs Player (mutually exclusive) -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Jersey Version" %}</label>
              <div class="btn-group w-100 fc-btn-group" role="group" aria-label="Version toggle">
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="isFanVersion ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setVersion('fan')">{% trans "Fan Version" %}</button>
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="!isFanVersion ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setVersion('player')">{% trans "Player Version" %}</button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Sleeve Type" %}</label>
              <div class="btn-group w-100 fc-btn-group" role="group" aria-label="Sleeve toggle">
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="isShortSleeve ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setSleeve('short')">{% trans "Short Sleeve" %}</button>
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="!isShortSleeve ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setSleeve('long')">{% trans "Long Sleeve" %}</button>
              </div>
            </div>
          </div>
          <!-- Binary options row (clear alignment) - Toggle switches -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Include Player Signature" %}</label>
              <label class="toggle-switch">
                <input type="checkbox" id="id_is_signed" name="is_signed" {% if form.is_signed.value %}checked{% endif %} />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Is replica" %}</label>
              <label class="toggle-switch">
                <input type="checkbox" id="id_is_replica" name="is_replica" {% if form.is_replica.value %}checked{% endif %} />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <!-- Nameset toggle button and fields -->
          <div class="mb-3">
            <button type="button" class="btn btn-outline-secondary" x-show="!hasNameset" @click="hasNameset = true">
              <i class="bi bi-person-badge"></i> {% trans "Add Nameset" %}
            </button>
            <button type="button" class="btn btn-outline-danger" x-show="hasNameset" @click="hasNameset = false">
              <i class="bi bi-x-circle"></i> {% trans "Remove Nameset" %}
            </button>
          </div>
          <!-- Nameset fields in same row below button -->
          <div class="row mb-3" x-show="hasNameset" x-cloak>
            <div class="col-md-6 mb-3">{{ form.player_name|as_crispy_field }}</div>
            <div class="col-md-6 mb-3">{{ form.number|as_crispy_field }}</div>
          </div>
          <!-- Hidden fields for form submission -->
          <div class="d-none">
            {{ form.is_fan_version }}
            {{ form.is_short_sleeve }}
            {{ form.is_signed }}
          </div>
        </div>
      </div>
      <!-- Photo Manager -->
      <div class="fc-card mb-4">
        <div class="fc-card-header">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Photos" %}</h5>
        </div>
        <div class="fc-card-body-flex-small-gap">
          <c-collection.photo_manager></c-collection.photo_manager>
        </div>
      </div>
      <!-- Submit Button -->
      <div class="d-flex justify-content-end gap-3 mt-4">
        <a href="{% url 'collection:item_list' %}" class="btn fc-btn-outline-secondary">{% trans "Cancel" %}</a>
        <button type="submit" id="submit-jersey-btn" class="btn fc-btn-primary">
          <span id="submit-text">{% trans "Add Jersey" %}</span>
          <span id="submit-spinner" class="spinner-border spinner-border-sm ms-2 fc-d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </form>
  </div>
{% endblock content %}
{% block js %}
  {{ block.super }}
  <script>
    // Show loading spinner when form is submitted
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('jersey-form');
      const submitBtn = document.getElementById('submit-jersey-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      const creatingText = '{% trans "Creating..." %}';

      if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
          submitSpinner.classList.remove('fc-d-none');
          submitSpinner.classList.add('fc-d-inline-block');
          submitText.textContent = creatingText;
          submitBtn.disabled = true;
          submitBtn.classList.add('fc-btn-disabled');
        });
      }
    });
  </script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('jerseyFormManual', () => ({
        isFanVersion: true, // Default to Fan Version
        isShortSleeve: true,
        hasNameset: false,

        init() {
          // Initialize version toggle (default to Fan Version)
          const fanInput = document.getElementById('id_is_fan_version');
          if (fanInput) {
            this.isFanVersion = fanInput.checked;
          } else {
            this.isFanVersion = true;
            if (fanInput) {
              fanInput.checked = true;
            }
          }

          // Initialize sleeve toggle (default to Short Sleeve)
          const shortSleeveInput = document.getElementById('id_is_short_sleeve');
          if (shortSleeveInput) {
            this.isShortSleeve = shortSleeveInput.checked;
          } else {
            this.isShortSleeve = true;
            if (shortSleeveInput) {
              shortSleeveInput.checked = true;
            }
          }

          // Initialize nameset checkbox
          const hasNamesetInput = document.getElementById('id_has_nameset');
          if (hasNamesetInput) {
            this.hasNameset = hasNamesetInput.checked;
          }
        },

        // Mutually exclusive version toggle handlers
        setVersion(version) {
          const fanInput = document.getElementById('id_is_fan_version');
          if (!fanInput) return;
          if (version === 'fan') {
            this.isFanVersion = true;
            fanInput.checked = true;
          } else {
            this.isFanVersion = false;
            fanInput.checked = false;
          }
          // Trigger change in case any listener depends on it
          fanInput.dispatchEvent(new Event('change', {
            bubbles: true
          }));
        },

        // Sleeve toggle maps to is_short_sleeve boolean
        setSleeve(type) {
          const input = document.getElementById('id_is_short_sleeve');
          if (!input) return;
          if (type === 'short') {
            this.isShortSleeve = true;
            input.checked = true;
          } else {
            this.isShortSleeve = false;
            input.checked = false;
          }
          input.dispatchEvent(new Event('change', {
            bubbles: true
          }));
        }
      }));
    });
  </script>
{% endblock js %}

{% extends "base.html" %}

{% load static %}
{% load i18n %}
{% load cache %}

{% block css %}
  {{ block.super }}
  <link href="{% static 'css/collection.css' %}" rel="stylesheet" />
  <link href="{% static 'css/users.css' %}" rel="stylesheet" />
{% endblock css %}
{% block title %}
  {% if is_user_collection %}
    {% blocktrans with username=profile_user.username %}Collection of {{ username }}{% endblocktrans %}
  {% else %}
    {% trans "My Collection" %}
  {% endif %}
{% endblock title %}
{% block content %}
  <div class="container">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}
      </div>
    {% endif %}
    <div class="row">
      <div class="col-lg-12">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="h3 mb-0">
            {% if is_user_collection %}
              {% blocktrans with username=profile_user.username %}Collection of {{ username }}{% endblocktrans %}
            {% else %}
              {% trans "My Collection" %}
            {% endif %}
          </h1>
          {% if not is_user_collection or profile_user == request.user %}
            <a href="{% url 'collection:jersey_create_automatic' %}" class="btn btn-primary fc-font-space-grotesk">
              <i class="bi bi-plus-circle"></i> {% trans "Add New Item" %}
            </a>
          {% endif %}
        </div>
        <!-- Collection Stats -->
        {% if is_user_collection %}
          <div class="row mb-4 stats-row" style="margin-bottom: 2.5rem !important;">
            <div class="col-md-3">
              <div class="card text-center stats-card">
                <div class="card-body">
                  <h5 class="card-title text-primary">{{ total_items }}</h5>
                  <p class="card-text text-muted">{% trans "Total Items" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center stats-card">
                <div class="card-body">
                  <h5 class="card-title text-success">{{ items|length }}</h5>
                  <p class="card-text text-muted">{% trans "On This Page" %}</p>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          {% cache 600 collection_stats request.user.pk %}
          <div class="row mb-4 stats-row" style="margin-bottom: 2.5rem !important;">
            <div class="col-md-3">
              <div class="card text-center stats-card">
                <div class="card-body">
                  <h5 class="card-title text-primary">{{ total_items }}</h5>
                  <p class="card-text text-muted">{% trans "Total Items" %}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center stats-card">
                <div class="card-body">
                  <h5 class="card-title text-success">{{ items|length }}</h5>
                  <p class="card-text text-muted">{% trans "On This Page" %}</p>
                </div>
              </div>
            </div>
          </div>
        {% endcache %}
      {% endif %}
      <!-- Items Grid -->
      {% if items %}
        {% if is_user_collection %}
          <div class="row" style="row-gap: 0.75rem;">
            {% for item in items %}
              {% include "cotton/item_card.html" with item=item show_user=False show_edit=can_edit_items show_delete=can_edit_items quick_view_enabled=True %}
            {% endfor %}
          </div>
        {% else %}
          {% cache 300 collection_items_grid request.user.pk page_obj.number %}
          <div class="row" style="row-gap: 0.75rem;">
            {% for item in items %}
              {% include "cotton/item_card.html" with item=item show_user=False show_edit=True show_delete=True quick_view_enabled=True %}
            {% endfor %}
          </div>
        {% endcache %}
      {% endif %}
      <!-- Pagination -->
      {% if is_paginated %}
        <nav aria-label="{% trans 'Collection pagination' %}">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1">{% trans "First" %}</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "Previous" %}</a>
              </li>
            {% endif %}
            <li class="page-item active">
              <span class="page-link">
                {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}
              </span>
            </li>
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "Next" %}</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{% trans "Last" %}</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <!-- Empty State -->
      <div class="text-center py-5">
        <i class="bi bi-collection text-muted empty-state-icon"></i>
        {% if is_user_collection %}
          <h3 class="mt-3 text-muted">{% trans "This user has no items yet" %}</h3>
          <p class="text-muted mb-4">
            {% blocktrans with username=profile_user.username %}{{ username }} has not added any items to their collection.{% endblocktrans %}
          </p>
          {% if can_edit_items %}
            <a href="{% url 'collection:item_create' %}" class="btn btn-primary btn-lg">
              <i class="bi bi-plus-circle"></i> {% trans "Add Your First Item" %}
            </a>
          {% endif %}
        {% else %}
          <h3 class="mt-3 text-muted">{% trans "No items in your collection yet" %}</h3>
          <p class="text-muted mb-4">{% trans "Start building your collection by adding your first item!" %}</p>
          <a href="{% url 'collection:item_create' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-circle"></i> {% trans "Add Your First Item" %}
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
</div>
{% include "cotton/quick_view_modal.html" %}
{% if not is_user_collection or can_edit_items %}
  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteItemModal" tabindex="-1" aria-labelledby="deleteItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-0 shadow-lg">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="deleteItemModalLabel">{% trans "Delete Item" %}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-4">
          <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
          <p class="mt-3 mb-1 text-light">
            {% trans "Are you sure you want to delete" %} <strong id="deleteItemName"></strong>?
          </p>
          <p class="text-secondary small">{% trans "This action cannot be undone." %}</p>
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <form id="deleteItemForm" method="post" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="page" id="deletePageInput" value="{{ page_obj.number|default:1 }}" />
            <button type="submit" class="btn btn-danger">
              <i class="bi bi-trash"></i> {% trans "Yes, delete" %}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
  function showDeleteModal(button) {
    const deleteUrl = button.getAttribute('data-delete-url');
    const itemName = button.dataset.itemName;
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteItemForm').action = deleteUrl;
    // Get current page from URL or use page_obj
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = urlParams.get('page') || '{{ page_obj.number|default:1 }}';
    document.getElementById('deletePageInput').value = currentPage;
    new bootstrap.Modal(document.getElementById('deleteItemModal')).show();
  }
  </script>
{% endif %}
{% endblock content %}

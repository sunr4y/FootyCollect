{% extends "base.html" %}

{% load i18n static %}
{% load crispy_forms_tags %}

{% block css %}
  {{ block.super }}
  {{ form.media.css }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/flag-icons@7.3.2/css/flag-icons.min.css" rel="stylesheet" />
  <style>
    /* Ensure country dropdown looks empty by default */
    #id_country_code {
      background-color: var(--fc-secondary) !important;
      border: 1px solid var(--fc-border) !important;
      color: var(--fc-foreground) !important;
    }

    #id_country_code:empty {
      background-color: var(--fc-secondary) !important;
    }

    .select2-container--bootstrap5 .select2-selection--single {
      background-color: var(--fc-secondary) !important;
      border: 1px solid var(--fc-border) !important;
      color: var(--fc-foreground) !important;
    }

    .form-control,
    .form-select {
      background-color: var(--fc-secondary) !important;
      border: 1px solid var(--fc-border) !important;
      color: var(--fc-foreground) !important;
    }

    .form-control:focus,
    .form-select:focus {
      background-color: var(--fc-secondary) !important;
      border-color: hsla(180, 85%, 40%, 1) !important;
      color: var(--fc-foreground) !important;
      box-shadow: 0 0 0 0.2rem hsla(180, 85%, 40%, 0.25) !important;
    }

    .form-label {
      color: var(--fc-muted-foreground) !important;
      font-size: 0.875rem !important;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--fc-secondary);
      border: 1px solid var(--fc-border);
      transition: 0.3s;
      border-radius: 26px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: var(--fc-foreground);
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: hsla(180, 85%, 40%, 1);
      border-color: hsla(180, 85%, 40%, 1);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(24px);
      background-color: white;
    }

    .toggle-switch input:focus+.toggle-slider {
      box-shadow: 0 0 0 3px hsla(180, 85%, 40%, 0.25);
    }

    /* ============================================================================
       SELECT2 DARK THEME - FOOTYCOLLECT
       ============================================================================ */

    /* Base container - m√°xima especificidad usando ID del campo */
    #id_country_code.select2-hidden-accessible~.select2-container--bootstrap5,
    #id_country_code~.select2-container--bootstrap5 {
      width: 100% !important;
      box-sizing: border-box;
    }

    /* SELECTION BOX - Estado normal, focus y open */
    #id_country_code~.select2-container--bootstrap5 .select2-selection,
    #id_country_code~.select2-container--bootstrap5.select2-container--focus .select2-selection,
    #id_country_code~.select2-container--bootstrap5.select2-container--open .select2-selection {
      background-color: var(--fc-secondary, #1a1a1a) !important;
      border: 1px solid var(--fc-border, #333333) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
      box-shadow: none !important;
    }

    /* Single selection variant */
    #id_country_code~.select2-container--bootstrap5 .select2-selection--single {
      background-color: var(--fc-secondary, #1a1a1a) !important;
      border: 1px solid var(--fc-border, #333333) !important;
      height: 38px !important;
      padding: 0 !important;
    }

    /* Rendered text (selected value) */
    #id_country_code~.select2-container--bootstrap5 .select2-selection__rendered,
    #id_country_code~.select2-container--bootstrap5 .select2-selection--single .select2-selection__rendered {
      color: var(--fc-foreground, #f0f0f0) !important;
      line-height: 38px !important;
      padding: 0 8px !important;
      padding-right: 30px !important;
      background-color: transparent !important;
      display: flex !important;
      align-items: center !important;
      height: 100% !important;
    }

    /* Choice tags/chips when value is selected */
    #id_country_code~.select2-container--bootstrap5 .select2-selection__choice {
      background-color: var(--fc-secondary, #1a1a1a) !important;
      border: 1px solid var(--fc-border, #333333) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
      padding: 2px 6px !important;
      margin: 2px 4px 2px 0 !important;
      border-radius: 4px !important;
      display: inline-flex !important;
      align-items: center !important;
      line-height: 1.4 !important;
      max-width: 100% !important;
    }

    /* Choice remove button (X) */
    #id_country_code~.select2-container--bootstrap5 .select2-selection__choice__remove {
      color: var(--fc-muted-foreground, #888888) !important;
      margin-right: 4px !important;
      margin-left: 0 !important;
      padding: 0 2px !important;
      font-size: 16px !important;
      line-height: 1 !important;
      height: auto !important;
      width: auto !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    #id_country_code~.select2-container--bootstrap5 .select2-selection__choice__remove:hover {
      color: var(--fc-foreground, #f0f0f0) !important;
    }

    /* Ensure flag icons in selection are aligned */
    #id_country_code~.select2-container--bootstrap5 .select2-selection__rendered .fi {
      margin-right: 6px !important;
      vertical-align: middle !important;
      display: inline-block !important;
      flex-shrink: 0 !important;
    }

    /* Selection container alignment */
    #id_country_code~.select2-container--bootstrap5 .select2-selection {
      display: flex !important;
      align-items: center !important;
      min-height: 38px !important;
    }

    /* Arrow icon styling */
    #id_country_code~.select2-container--bootstrap5 .select2-selection__arrow {
      height: 36px !important;
      width: 20px !important;
      right: 1px !important;
      top: 1px !important;
      background-color: transparent !important;
    }

    #id_country_code~.select2-container--bootstrap5 .select2-selection__arrow b {
      border-color: var(--fc-foreground, #f0f0f0) transparent transparent transparent !important;
      border-width: 5px 4px 0 4px !important;
      margin: 5px 2px 0 !important;
    }

    /* Arrow cuando el dropdown est√° abierto */
    #id_country_code~.select2-container--bootstrap5.select2-container--open .select2-selection__arrow b {
      border-color: transparent transparent var(--fc-foreground, #f0f0f0) transparent !important;
      border-width: 0 4px 5px 4px !important;
    }

    /* DROPDOWN - Contenedor principal */
    .select2-container--bootstrap5 .select2-dropdown {
      background-color: var(--fc-card, #0f0f0f) !important;
      border: 1px solid var(--fc-border, #333333) !important;
      border-top: none !important;
      color: var(--fc-foreground, #f0f0f0) !important;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
    }

    .select2-container--bootstrap5 .select2-dropdown.select2-dropdown--below {
      border-top: 1px solid var(--fc-border, #333333) !important;
    }

    /* Search field dentro del dropdown */
    .select2-container--bootstrap5 .select2-search--dropdown {
      background-color: var(--fc-card, #0f0f0f) !important;
      padding: 8px !important;
      border-bottom: 1px solid var(--fc-border, #333333) !important;
    }

    .select2-container--bootstrap5 .select2-search--dropdown .select2-search__field,
    .select2-container--bootstrap5 .select2-search--dropdown .select2-search__field:focus {
      background-color: var(--fc-secondary, #1a1a1a) !important;
      border: 1px solid var(--fc-border, #333333) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
      padding: 6px 12px !important;
      font-size: 14px !important;
    }

    .select2-container--bootstrap5 .select2-search--dropdown .select2-search__field:focus {
      border-color: var(--fc-primary, #32b8c6) !important;
      outline: none !important;
      box-shadow: 0 0 0 3px rgba(50, 184, 198, 0.25) !important;
    }

    /* RESULTS - Contenedor de opciones */
    .select2-container--bootstrap5 .select2-results {
      background-color: var(--fc-card, #0f0f0f) !important;
    }

    .select2-container--bootstrap5 .select2-results__options {
      background-color: var(--fc-card, #0f0f0f) !important;
    }

    /* Opci√≥n individual */
    .select2-container--bootstrap5 .select2-results__option,
    .select2-container--bootstrap5 .select2-results__option[role="option"] {
      background-color: var(--fc-card, #0f0f0f) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
      padding: 8px 12px !important;
      line-height: 1.5 !important;
      transition: background-color 0.15s ease !important;
    }

    /* Opci√≥n highlighted (cuando pasas el mouse) */
    .select2-container--bootstrap5 .select2-results__option--highlighted,
    .select2-container--bootstrap5 .select2-results__option--highlighted[role="option"] {
      background-color: rgba(50, 184, 198, 0.2) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
    }

    /* Opci√≥n selected */
    .select2-container--bootstrap5 .select2-results__option[aria-selected="true"],
    .select2-container--bootstrap5 .select2-results__option[aria-selected="true"][role="option"] {
      background-color: rgba(50, 184, 198, 0.15) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
    }

    /* Opci√≥n selected AND highlighted */
    .select2-container--bootstrap5 .select2-results__option[aria-selected="true"].select2-results__option--highlighted {
      background-color: rgba(50, 184, 198, 0.3) !important;
      color: var(--fc-foreground, #f0f0f0) !important;
    }

    /* No results message */
    .select2-container--bootstrap5 .select2-results__message {
      background-color: var(--fc-card, #0f0f0f) !important;
      color: var(--fc-muted-foreground, #888888) !important;
      padding: 8px 12px !important;
    }

    /* DISABLED state */
    .select2-container--bootstrap5.select2-container--disabled .select2-selection {
      background-color: var(--fc-muted, #242424) !important;
      border-color: var(--fc-border, #333333) !important;
      color: var(--fc-muted-foreground, #888888) !important;
      cursor: not-allowed !important;
    }

    /* PLACEHOLDER text */
    .select2-container--bootstrap5 .select2-selection__placeholder {
      color: var(--fc-muted-foreground, #888888) !important;
    }

    /* Clearable button (X) */
    .select2-container--bootstrap5 .select2-selection__clear {
      color: var(--fc-foreground, #f0f0f0) !important;
      margin-right: 5px !important;
    }

    /* ============================================================================
       RESPONSIVE ADJUSTMENTS
       ============================================================================ */

    @media (max-width: 576px) {
      .select2-container--bootstrap5 .select2-selection {
        height: 36px !important;
      }

      .select2-container--bootstrap5 .select2-selection__rendered {
        line-height: 36px !important;
      }
    }

    /* Remove gap after description */
    #div_id_description {
      margin-bottom: 0 !important;
    }

    /* Change blue buttons to teal */
    .btn-primary {
      background-color: hsla(180, 85%, 40%, 1) !important;
      border-color: hsla(180, 85%, 40%, 1) !important;
    }

    .btn-primary:hover {
      background-color: hsla(180, 85%, 35%, 1) !important;
      border-color: hsla(180, 85%, 35%, 1) !important;
    }

    .btn-outline-primary {
      border-color: hsla(180, 85%, 40%, 1) !important;
      color: hsla(180, 85%, 40%, 1) !important;
    }

    .btn-outline-primary:hover {
      background-color: hsla(180, 85%, 40%, 0.1) !important;
      border-color: hsla(180, 85%, 40%, 1) !important;
      color: hsla(180, 85%, 40%, 1) !important;
    }

    /* Ensure flag icons render properly in select2 */
    .select2-results__option .fi {
      margin-right: 8px;
      border-radius: 3px;
      width: 1.3em;
      height: 1em;
      box-shadow: 0 0 1px rgba(0, 0, 0, 0.2);
      vertical-align: middle;
      display: inline-block;
    }

    .select2-selection__rendered .fi {
      margin-right: 8px;
      border-radius: 3px;
      width: 1.3em;
      height: 1em;
      box-shadow: 0 0 1px rgba(0, 0, 0, 0.2);
      vertical-align: middle;
      display: inline-block;
    }

    .fi {
      margin-right: 8px;
      border-radius: 3px;
      width: 1.3em;
      height: 1em;
      box-shadow: 0 0 1px rgba(0, 0, 0, 0.2);
      vertical-align: middle;
    }

    .select2-results__option {
      line-height: 1.8em;
    }

    .select2-selection__rendered .fi {
      margin-right: 5px;
      vertical-align: -0.1em;
    }

    /* Styles for color selectors */
    .color-swatch {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 5px;
      border-radius: 3px;
      border: 1px solid #ddd;
      vertical-align: middle;
    }

    /* Styles for design selector */
    .design-option {
      display: flex;
      align-items: center;
      padding: 5px;
    }

    .design-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }

    /* Styles for search results - Dark Theme */
    .kit-search-results {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background: var(--fc-card, #141820) !important;
      border: 1px solid var(--fc-border, #242c36) !important;
      border-radius: 0.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      color: var(--fc-foreground, #f0f0e8) !important;
      overflow: hidden;
    }

    /* Custom scrollbar for search results - Dark Theme */
    .kit-search-results::-webkit-scrollbar {
      width: 8px;
    }

    .kit-search-results::-webkit-scrollbar-track {
      background: var(--fc-secondary, #1a1f2b) !important;
      border-radius: 4px;
    }

    .kit-search-results::-webkit-scrollbar-thumb {
      background: var(--fc-border, #242c36) !important;
      border-radius: 4px;
      border: 1px solid var(--fc-secondary, #1a1f2b);
    }

    .kit-search-results::-webkit-scrollbar-thumb:hover {
      background: var(--fc-muted, #242c36) !important;
    }

    /* Firefox scrollbar */
    .kit-search-results {
      scrollbar-width: thin;
      scrollbar-color: var(--fc-border, #242c36) var(--fc-secondary, #1a1f2b);
    }

    .kit-search-item {
      display: flex;
      align-items: center;
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid var(--fc-border, #242c36) !important;
      color: var(--fc-foreground, #f0f0e8) !important;
      transition: background-color 0.15s ease;
    }

    .kit-search-item:last-child {
      border-bottom: none !important;
    }

    .kit-search-item:hover {
      background-color: var(--fc-secondary, #1a1f2b) !important;
    }

    .kit-search-item .fw-bold {
      color: var(--fc-foreground, #f0f0e8) !important;
    }

    .kit-search-item .text-muted {
      color: var(--fc-muted-foreground, #8b92a0) !important;
    }

    /* Header del dropdown de resultados */
    .kit-search-results>.p-2 {
      background-color: var(--fc-secondary, #1a1f2b) !important;
      border-bottom: 1px solid var(--fc-border, #242c36) !important;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }

    .kit-search-results .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
      opacity: 0.7;
    }

    .kit-search-results .btn-close:hover {
      opacity: 1;
    }

    .kit-search-item-img-container {
      width: 50px;
      height: 50px;
      min-width: 50px;
      min-height: 50px;
      margin-right: 10px;
      border: 1px solid var(--fc-border, #242c36) !important;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
      background-color: var(--fc-secondary, #1a1f2b) !important;
      position: relative;
    }

    .kit-search-item img {
      width: 50px !important;
      height: 50px !important;
      object-fit: contain;
      max-width: 50px !important;
      max-height: 50px !important;
    }

    .loading-indicator {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      pointer-events: none;
    }

    .loading-indicator .spinner-border {
      border-color: hsla(180, 85%, 40%, 0.3) !important;
      border-right-color: hsla(180, 85%, 40%, 1) !important;
      width: 1rem !important;
      height: 1rem !important;
    }

    .search-timestamp {
      display: none;
    }

    .placeholder-img {
      width: 40px;
      height: 40px;
      background-color: var(--fc-secondary, #1a1f2b) !important;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--fc-muted-foreground, #8b92a0) !important;
      font-size: 18px;
    }

    /* Add a spinner for images in loading */
    .img-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(248, 249, 250, 0.7);
    }

    .img-loading .spinner-border {
      width: 1rem;
      height: 1rem;
    }

    /* Spinner for API loading - Teal color */
    .card-header .spinner-border {
      border-color: hsla(180, 85%, 40%, 0.3) !important;
      border-right-color: hsla(180, 85%, 40%, 1) !important;
      width: 1rem !important;
      height: 1rem !important;
    }

    /* Styles for the default image */
    .default-image-preview {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-top: 15px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }

    .default-image-preview h6 {
      margin-bottom: 10px;
      color: #495057;
    }

    .default-image-preview img {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
      display: block;
      margin: 0 auto 10px auto;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 5px;
      background-color: white;
    }

    /* Improve switch/checkbox hierarchy and sizing */
    .form-switch .form-check-input {
      width: 3rem;
      height: 1.5rem;
    }

    .form-switch .form-check-label {
      margin-left: 0.5rem;
      font-weight: 500;
    }

    /* Button groups visual feedback */
    .btn-group .btn.btn-primary {
      box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.25);
    }

    .btn-group .btn {
      transition: all 120ms ease-in-out;
    }
  </style>
{% endblock css %}
{% block inline_javascript %}
  <script>
    // Function to debounce the searches
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    // Handle image loading errors
    function handleImageError(img) {
      img.outerHTML = '<div class="placeholder-img"><i class="bi bi-image"></i></div>';
    }

    // Verify the state of the photo_manager when the page is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Wait a moment for Alpine.js to initialize the components
      setTimeout(function() {
        console.log('Verificando el estado del componente photo_manager...');
        const photoManager = document.querySelector('.photo-manager');

        if (photoManager) {
          console.log('Componente photo_manager encontrado');
        } else {
          console.log('No se encontr√≥ el componente photo_manager');
        }
      }, 1000);
    });

    // Function to add default image to photos
    function addDefaultImageToPhotos() {
      try {
        // Get the main image URL from the hidden field
        const mainImgUrl = document.getElementById('id_main_img_url').value;

        if (!mainImgUrl) {
          alert('{% trans "No default image available. Please select a kit first." %}');
          return;
        }

        console.log('Adding default image to photos:', mainImgUrl);

        // Verify if the image has already been added
        const existingImages = document.querySelectorAll('.default-image-preview img');
        for (let i = 0; i < existingImages.length; i++) {
          if (existingImages[i].src === mainImgUrl) {
            console.log('The image has already been added');
            alert('{% trans "This image has already been added." %}');
            return;
          }
        }

        // Method 3: Create a visual element without interfering with the component
        try {
          console.log('Creating a visual element for the default image');

          // Create a hidden field to store the image URL
          const form = document.getElementById('jersey-form');
          let hiddenInput = form.querySelector('input[name="external_image_urls"]');
          if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'external_image_urls';
            form.appendChild(hiddenInput);
          }

          // Add the image URL to the hidden field
          const urls = hiddenInput.value ? hiddenInput.value.split(',') : [];
          if (!urls.includes(mainImgUrl)) {
            urls.push(mainImgUrl);
            hiddenInput.value = urls.join(',');
          }

          // Create a container to show the image
          const previewContainer = document.createElement('div');
          previewContainer.className = 'default-image-preview mt-3 mb-3';
          previewContainer.style.border = '1px solid #ddd';
          previewContainer.style.borderRadius = '4px';
          previewContainer.style.padding = '10px';

          // Create the title
          const title = document.createElement('h6');
          title.className = 'mb-2';
          title.textContent = '{% trans "Default Image (will be processed on submission)" %}';

          // Create the image
          const img = document.createElement('img');
          img.src = mainImgUrl;
          img.alt = 'Default image';
          img.style.maxWidth = '100%';
          img.style.maxHeight = '200px';
          img.style.objectFit = 'contain';

          // Create the button to remove the image
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn btn-sm btn-outline-danger mt-2';
          removeBtn.innerHTML = '<i class="bi bi-trash"></i> {% trans "Remove" %}';
          removeBtn.onclick = function() {
            // Remove the URL from the hidden field
            const urls = hiddenInput.value.split(',');
            const index = urls.indexOf(mainImgUrl);
            if (index !== -1) {
              urls.splice(index, 1);
              hiddenInput.value = urls.join(',');
            }

            // Remove the container
            previewContainer.remove();

            // Show the add image button
            document.getElementById('add-default-image').style.display = 'inline-block';
          };

          // Add the elements to the container
          previewContainer.appendChild(title);
          previewContainer.appendChild(img);
          previewContainer.appendChild(removeBtn);

          // Add the container after the button
          const buttonContainer = document.getElementById('add-default-image').parentNode;
          buttonContainer.appendChild(previewContainer);

          // Hide the add image button after adding the image
          document.getElementById('add-default-image').style.display = 'none';

          // Show a success message
          alert('{% trans "Default image added successfully! It will be processed when you submit the form." %}');

          console.log('Imagen a√±adida correctamente');
          return;
        } catch (error) {
          console.error('Error creating the visual element:', error);
        }

        // If we get here, none of the methods have worked
        alert('{% trans "Could not add the default image. Please try adding it manually." %}');
      } catch (error) {
        console.error('Error en addDefaultImageToPhotos:', error);
        alert('{% trans "Error adding default image. Please try again or add it manually." %}');
      }
    }

    // Global function to update Cotton components
    function updateCottonComponent(fieldName, value) {
      try {
        console.log(`üöÄ updateCottonComponent called for ${fieldName} with:`, value);
        console.log(`üöÄ updateCottonComponent - fieldName type: ${typeof fieldName}, value: ${fieldName}`);
        const select = document.getElementById(`id_${fieldName}`);
        if (!select) {
          console.warn(`No se encontr√≥ el select para el campo ${fieldName}`);
          return;
        }

        // Update the value of the select
        if (Array.isArray(value)) {
          // For multiple selects
          if (select.options && select.options.length > 0) {
            // Deselect all options first
            for (let i = 0; i < select.options.length; i++) {
              select.options[i].selected = false;
            }

            // Select the corresponding options
            for (let i = 0; i < select.options.length; i++) {
              const optionText = select.options[i].text.trim().toLowerCase();
              for (const val of value) {
                const valueText = val.toString().trim().toLowerCase();
                if (optionText === valueText || optionText.includes(valueText) || valueText.includes(optionText)) {
                  select.options[i].selected = true;
                  break;
                }
              }
            }
          }

          // Update the visual component of Cotton for arrays too
          updateCottonVisual(fieldName, value);
        } else {
          // For simple selects
          const valueText = value.toString().trim().toLowerCase();
          let found = false;

          if (select.options && select.options.length > 0) {
            for (let i = 0; i < select.options.length; i++) {
              const optionText = select.options[i].text.trim().toLowerCase();
              if (optionText === valueText || optionText.includes(valueText) || valueText.includes(optionText)) {
                select.value = select.options[i].value;
                found = true;
                break;
              }
            }
          }

          // Trigger change event to update the display
          const event = new Event('change', {
            bubbles: true
          });
          select.dispatchEvent(event);

          console.log(`Cotton component ${fieldName} updated with value:`, value);

          // Update the visual component of Cotton
          console.log(`üéØ Calling updateCottonVisual for ${fieldName} with value:`, value);
          updateCottonVisual(fieldName, value);
        }
      } catch (error) {
        console.error(`Error al actualizar el componente Cotton ${fieldName}:`, error);
      }
    }

    // Global function to update the visual display of Cotton components
    function updateCottonVisual(fieldName, value) {
      try {
        console.log(`üé® updateCottonVisual called for ${fieldName} with value:`, value);
        console.log(`üé® updateCottonVisual - fieldName type: ${typeof fieldName}, value: ${fieldName}`);
        // Find the container of the Cotton component
        const cottonContainer = document.getElementById(`div_id_${fieldName}`);
        console.log(`üîç Looking for container div_id_${fieldName}:`, cottonContainer);
        if (!cottonContainer) {
          console.log(`‚ùå No container found for ${fieldName}`);
          return;
        }

        // Find the Cotton component inside the container
        // Cotton processes the components, so we look for the rendered elements
        const cottonComponent = cottonContainer.querySelector(`.color-selector-container, .design-selector-container`);
        console.log(`üîç Looking for Cotton component in container:`, cottonComponent);
        if (!cottonComponent) {
          console.log(`‚ùå No Cotton component found in container for ${fieldName}`);
          return;
        }

        // Update the data-selected attribute
        cottonComponent.setAttribute('data-selected', Array.isArray(value) ? value.join(',') : value);

        // For colors, trigger the color selector functions
        console.log(`üîç Checking fieldName for color processing: ${fieldName}`);
        if (fieldName === 'main_color' || fieldName === 'secondary_colors') {
          console.log(`üé® COLOR SELECTION: Processing ${fieldName} with value:`, value);
          console.log(`üé® COLOR SELECTION: fieldName check - main_color: ${fieldName === 'main_color'}, secondary_colors: ${fieldName === 'secondary_colors'}`);
          // Wait a bit for the component to be ready
          setTimeout(() => {
            console.log(`üîç Looking for color selector in container:`, cottonContainer);

            // Find the color selector component (rendered by Cotton)
            const colorSelector = cottonContainer.querySelector('.color-selector-container');
            console.log(`Color selector found:`, colorSelector);

            if (colorSelector) {
              // Find the color circles (rendered by Cotton)
              const colorCircles = colorSelector.querySelectorAll('.color-option');
              console.log(`Found ${colorCircles.length} color circles for ${fieldName}`);

              // Debug: log all available color values
              const availableColors = Array.from(colorCircles).map(circle => circle.getAttribute('data-value'));
              console.log(`Available colors:`, availableColors);

              if (fieldName === 'main_color' && !Array.isArray(value)) {
                // Single color selection
                console.log(`Looking for main color: ${value}`);
                colorCircles.forEach((circle, index) => {
                  const circleValue = circle.getAttribute('data-value');
                  console.log(`Circle ${index}: ${circleValue} (looking for: ${value})`);
                  if (circleValue.toUpperCase() === value.toUpperCase()) {
                    console.log(`‚úÖ MATCH! Selecting color circle for ${value}`);
                    // Remove selected from all circles first
                    colorCircles.forEach(c => c.classList.remove('selected'));
                    // Add selected to this circle
                    circle.classList.add('selected');
                    // Update the hidden field
                    const hiddenField = document.getElementById('id_main_color');
                    if (hiddenField) {
                      hiddenField.value = value;
                      console.log(`Updated hidden field id_main_color to: ${value}`);

                      // Also update the select options
                      const selectOptions = hiddenField.options;
                      for (let i = 0; i < selectOptions.length; i++) {
                        selectOptions[i].selected = (selectOptions[i].value === value);
                      }
                      console.log(`Updated select options for main_color`);
                    }
                  }
                });
              } else if (fieldName === 'secondary_colors' && Array.isArray(value)) {
                // Multiple color selection
                console.log(`Looking for secondary colors:`, value);
                value.forEach(val => {
                  colorCircles.forEach(circle => {
                    const circleValue = circle.getAttribute('data-value');
                    if (circleValue.toUpperCase() === val.toUpperCase()) {
                      console.log(`‚úÖ MATCH! Selecting secondary color circle for ${val}`);
                      circle.classList.add('selected');
                      // Update the hidden field (for secondary colors, we need to handle multiple values)
                      const hiddenField = document.getElementById('id_secondary_colors');
                      if (hiddenField) {
                        // Get current values and add this one
                        const currentValues = hiddenField.value ? hiddenField.value.split(',') : [];
                        if (!currentValues.includes(val)) {
                          currentValues.push(val);
                          hiddenField.value = currentValues.join(',');
                          console.log(`Updated hidden field id_secondary_colors to: ${hiddenField.value}`);

                          // Also update the select options
                          const selectOptions = hiddenField.options;
                          for (let i = 0; i < selectOptions.length; i++) {
                            selectOptions[i].selected = currentValues.includes(selectOptions[i].value);
                          }
                          console.log(`Updated select options for secondary_colors`);
                        }
                      }
                    }
                  });
                });
              }
            } else {
              console.log(`‚ùå No color selector found in container`);
            }
          }, 500);
        }

        // For designs, trigger the design selector functions
        if (fieldName === 'design') {
          console.log(`üé® DESIGN SELECTION: Processing ${fieldName} with value:`, value);
          // Wait a bit for the component to be ready
          setTimeout(() => {
            console.log(`üîç Looking for design selector in container:`, cottonContainer);

            // Find the design selector component (rendered by Cotton)
            const designSelector = cottonContainer.querySelector('.design-selector-container');
            console.log(`Design selector found:`, designSelector);

            if (designSelector) {
              // Find the design options (rendered by Cotton)
              const designOptions = designSelector.querySelectorAll('.design-option');
              console.log(`Found ${designOptions.length} design options for ${fieldName}`);

              // Debug: log all available design values
              const availableDesigns = Array.from(designOptions).map(option => option.getAttribute('data-value'));
              console.log(`Available designs:`, availableDesigns);

              console.log(`Looking for design: ${value}`);
              designOptions.forEach((option, index) => {
                const optionValue = option.getAttribute('data-value');
                console.log(`Design option ${index}: ${optionValue} (looking for: ${value})`);
                if (optionValue === value) {
                  console.log(`‚úÖ MATCH! Selecting design option for ${value}`);
                  // Remove selected from all options first
                  designOptions.forEach(o => o.classList.remove('selected'));
                  // Add selected to this option
                  option.classList.add('selected');
                  // Update the hidden field
                  const hiddenField = document.getElementById('id_design');
                  if (hiddenField) {
                    hiddenField.value = value;
                    console.log(`Updated hidden field id_design to: ${value}`);

                    // Also update the select options
                    const selectOptions = hiddenField.options;
                    for (let i = 0; i < selectOptions.length; i++) {
                      selectOptions[i].selected = (selectOptions[i].value === value);
                    }
                    console.log(`Updated select options for design`);
                  }
                }
              });
            } else {
              console.log(`‚ùå No design selector found in container`);
            }
          }, 500);
        }

        console.log(`Cotton visualization for ${fieldName} updated with:`, value);
      } catch (error) {
        console.error(`Error updating Cotton visualization for ${fieldName}:`, error);
      }
    }

    // Define the jerseyForm component for Alpine.js
    document.addEventListener('alpine:init', () => {
      Alpine.data('jerseyForm', () => ({
        kitSearch: '',
        kitResults: [],
        isSearching: false,
        selectedKit: null,
        lastSearchTimestamp: 0,
        debouncedSearchKits: null,

        // UI state for version toggle and nameset
        isFanVersion: true,
        hasNameset: false,
        isShortSleeve: true,

        clubSearch: '',
        clubResults: [],
        isSearchingClub: false,
        selectedClub: null,
        lastClubSearchTimestamp: 0,
        debouncedSearchClubs: null,

        seasons: [],
        selectedSeasonId: '',

        showClubSearch: true,

        kitData: null,

        init() {
          // Inicializar el formulario
          // Initialize version toggle (default to Fan Version)
          const fanInput = document.getElementById('id_is_fan_version');
          this.isFanVersion = true;
          if (fanInput) {
            fanInput.checked = true;
          }
          const hasNamesetInput = document.getElementById('id_has_nameset');
          if (hasNamesetInput) {
            this.hasNameset = !!hasNamesetInput.checked;
          }
          const shortSleeveInput = document.getElementById('id_is_short_sleeve');
          if (shortSleeveInput) {
            this.isShortSleeve = !!shortSleeveInput.checked;
          }

          // Hide original fan/version and nameset checkboxes containers (we provide custom UI)
          const fanDiv = document.getElementById('div_id_is_fan_version');
          if (fanDiv) fanDiv.style.display = 'none';
          const namesetDiv = document.getElementById('div_id_has_nameset');
          if (namesetDiv) namesetDiv.style.display = 'none';
          const shortSleeveDiv = document.getElementById('div_id_is_short_sleeve');
          if (shortSleeveDiv) shortSleeveDiv.style.display = 'none';
          this.$watch('kitSearch', (value) => {
            if (value.length < 3) {
              this.kitResults = [];
              return;
            }

            // Usar la funci√≥n de b√∫squeda con debounce
            if (!this.debouncedSearchKits) {
              this.debouncedSearchKits = debounce(this.searchKits.bind(this), 500);
            }
            this.debouncedSearchKits();
          });

          this.$watch('clubSearch', (value) => {
            if (value.length < 3) {
              this.clubResults = [];
              return;
            }

            // Usar la funci√≥n de b√∫squeda con debounce
            if (!this.debouncedSearchClubs) {
              this.debouncedSearchClubs = debounce(this.searchClubs.bind(this), 500);
            }
            this.debouncedSearchClubs();
          });

          // Load countries after a short delay to ensure form.media.js has initialized Select2
          // If Select2 is not initialized by form.media.js, we'll initialize it ourselves
          setTimeout(() => {
            const countrySelect = $('#id_country_code');
            if (countrySelect.length) {
              // Check if Select2 is already initialized
              if (countrySelect.hasClass('select2-hidden-accessible')) {
                // Select2 is initialized, but we need to load countries if the dropdown is empty
                if (countrySelect.find('option').length <= 1) {
                  this.loadAllCountries();
                }
              } else {
                // Select2 is not initialized, so initialize it with countries
                this.loadAllCountries();
              }
            }
          }, 500);
        },

        // Mutually exclusive version toggle handlers
        setVersion(version) {
          const fanInput = document.getElementById('id_is_fan_version');
          if (!fanInput) return;
          if (version === 'fan') {
            this.isFanVersion = true;
            fanInput.checked = true;
          } else {
            this.isFanVersion = false;
            fanInput.checked = false;
          }
          // Trigger change in case any listener depends on it
          fanInput.dispatchEvent(new Event('change', {
            bubbles: true
          }));
        },

        // Nameset UI
        enableNameset() {
          this.hasNameset = true;
          const hasNamesetInput = document.getElementById('id_has_nameset');
          if (hasNamesetInput) {
            hasNamesetInput.checked = true;
            hasNamesetInput.dispatchEvent(new Event('change', {
              bubbles: true
            }));
          }
        },
        disableNameset() {
          this.hasNameset = false;
          const hasNamesetInput = document.getElementById('id_has_nameset');
          if (hasNamesetInput) {
            hasNamesetInput.checked = false;
            hasNamesetInput.dispatchEvent(new Event('change', {
              bubbles: true
            }));
          }
          // Clear player fields if present
          const playerName = document.getElementById('id_player_name');
          const playerNumber = document.getElementById('id_number');
          if (playerName) playerName.value = '';
          if (playerNumber) playerNumber.value = '';
        },

        // Sleeve toggle maps to is_short_sleeve boolean
        setSleeve(type) {
          const input = document.getElementById('id_is_short_sleeve');
          if (!input) return;
          if (type === 'short') {
            this.isShortSleeve = true;
            input.checked = true;
          } else {
            this.isShortSleeve = false;
            input.checked = false;
          }
          input.dispatchEvent(new Event('change', {
            bubbles: true
          }));
        },

        // Load all countries by default
        loadAllCountries() {
          console.log('Loading all countries by default...');
          const countrySelect = $('#id_country_code');
          if (!countrySelect.length) {
            // If select element doesn't exist yet, wait and try again
            setTimeout(() => {
              this.loadAllCountries();
            }, 500);
            return;
          }

          fetch('/core/country-autocomplete/')
            .then(response => response.json())
            .then(data => {
              // Destroy Select2 if it's already initialized to ensure clean re-initialization
              if (countrySelect.hasClass('select2-hidden-accessible')) {
                countrySelect.select2('destroy');
              }

              // Clear existing options
              countrySelect.empty();

              // Add all countries to the dropdown
              data.results.forEach(country => {
                // Create option element manually to avoid HTML escaping
                const option = document.createElement('option');
                option.value = country.id;
                option.innerHTML = country.text; // Use innerHTML to render HTML
                countrySelect.append(option);
              });

              // Re-initialize Select2 with proper template functions for flags
              countrySelect.select2({
                theme: 'bootstrap5',
                width: '100%',
                placeholder: 'Select a country...',
                allowClear: true,
                templateResult: function(country) {
                  if (!country.id) return country.text;
                  // Return the HTML as a jQuery object - country.text already contains HTML with flag
                  return $('<span>' + country.text + '</span>');
                },
                templateSelection: function(country) {
                  if (!country.id) return country.text;
                  // Return the HTML as a jQuery object - country.text already contains HTML with flag
                  return $('<span>' + country.text + '</span>');
                },
                escapeMarkup: function(markup) {
                  // Don't escape HTML, allow it to render
                  return markup;
                }
              });

              // Clear any default selection
              countrySelect.val(null).trigger('change');

              console.log('All countries loaded with proper rendering:', data.results.length);
            })
            .catch(error => {
              console.error('Error loading countries:', error);
            });
        },

        searchKits() {
          if (this.kitSearch.length < 3) return;

          // Crear un timestamp para esta b√∫squeda
          const searchTimestamp = Date.now();
          this.lastSearchTimestamp = searchTimestamp;

          this.isSearching = true;
          const url = `/fkapi/kits/search/?keyword=${encodeURIComponent(this.kitSearch)}`;
          console.log('Searching kits with URL:', url);

          fetch(url)
            .then(response => {
              console.log('Kit search response status:', response.status);
              if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
              }
              return response.json();
            })
            .then(data => {
              // Solo actualizar los resultados si esta es la b√∫squeda m√°s reciente
              if (searchTimestamp === this.lastSearchTimestamp) {
                console.log('Kit search results:', data);

                // Handle different API response formats
                let resultsArray = [];
                if (Array.isArray(data)) {
                  // API returns list directly
                  resultsArray = data;
                } else if (data.results && Array.isArray(data.results)) {
                  // API returns dict with results property
                  resultsArray = data.results;
                } else {
                  // Fallback: empty array
                  resultsArray = [];
                  console.warn('Unexpected API response format:', typeof data, data);
                }

                this.kitResults = resultsArray;
              } else {
                console.log('Ignoring outdated search results');
              }
              this.isSearching = false;
            })
            .catch(error => {
              console.error('Error searching kits:', error);
              this.isSearching = false;
              // Show an error message to the user
              alert('Error al buscar kits: ' + error.message);
            });
        },

        selectKit(kit) {
          try {
            this.selectedKit = kit;
            this.kitResults = [];
            // Don't update kitSearch to avoid unnecessary API call
            // this.kitSearch = kit.name;
            this.showClubSearch = false;

            try {
              // Show a message that the kit has been selected
              const searchCardTitle = document.querySelector('.card-header h5.card-title');
              if (searchCardTitle && searchCardTitle.textContent.includes('Search')) {
                const searchCard = searchCardTitle.closest('.card');
                if (searchCard) {
                  // Show a confirmation message
                  const confirmationMessage = document.createElement('div');
                  confirmationMessage.className = 'alert alert-success mt-3';
                  confirmationMessage.innerHTML = `
                  <strong><i class="bi bi-check-circle-fill"></i> Kit seleccionado:</strong> ${kit.name}
                  <p class="mb-0 small">Los datos del kit se est√°n cargando...</p>
                `;

                  const cardBody = searchCard.querySelector('.card-body');
                  if (cardBody) {
                    cardBody.appendChild(confirmationMessage);

                    // Hide the search inputs
                    const searchInputs = cardBody.querySelectorAll('.input-group, .position-relative');
                    searchInputs.forEach(input => {
                      input.style.display = 'none';
                    });

                    // Hide the "Or" text
                    const orText = cardBody.querySelector('p.text-center');
                    if (orText) {
                      orText.style.display = 'none';
                    }
                  }
                }
              }
            } catch (error) {
              console.error('Error al mostrar mensaje de confirmaci√≥n:', error);
            }

            // Get full kit details
            const url = `/fkapi/kit/${kit.id}/`;
            console.log('Getting kit details with URL:', url);

            fetch(url)
              .then(response => {
                console.log('Kit details response status:', response.status);
                if (!response.ok) {
                  throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
              })
              .then(data => {
                console.log('Kit details:', data);

                // Save the kit ID first
                const kitIdField = document.getElementById('id_kit_id');
                if (kitIdField) {
                  kitIdField.value = kit.id;
                }

                // Populate form synchronously (the visual updates will happen asynchronously)
                this.populateFormFromKit(data);

                try {
                  // Update the confirmation message
                  const confirmationMessage = document.querySelector('.alert.alert-success');
                  if (confirmationMessage) {
                    confirmationMessage.innerHTML = `
                    <strong><i class="bi bi-check-circle-fill"></i> Kit seleccionado:</strong> ${kit.name}
                    <p class="mb-0 small">Datos cargados correctamente. Puedes continuar con el formulario.</p>
                  `;
                  }
                } catch (error) {
                  console.error('Error al actualizar mensaje de confirmaci√≥n:', error);
                }
              })
              .catch(error => {
                console.error('Error getting kit details:', error);
                // Show an error message to the user
                alert('Error al obtener los detalles del kit: ' + error.message);
              });
          } catch (error) {
            console.error('Error en selectKit:', error);
            alert('Error al seleccionar el kit: ' + error.message);
          }
        },

        populateFormFromKit(kitData) {
          this.kitData = kitData;
          console.log('Populando formulario con datos:', kitData);
          console.log('üéØ populateFormFromKit - main_color:', kitData?.primary_color);
          console.log('üéØ populateFormFromKit - secondary_colors:', kitData?.secondary_colors);
          console.log('üéØ populateFormFromKit - Starting color processing...');

          // Log competition data
          if (kitData.competition) {
            console.log('Competition data from API:', {
              raw: kitData.competition,
              type: typeof kitData.competition,
              isArray: Array.isArray(kitData.competition)
            });
          }

          // Lock all fields that will be populated
          const fieldsToLock = ['brand', 'club', 'season', 'competition', 'kit_type'];
          fieldsToLock.forEach(field => {
            const element = document.getElementById(`id_${field}`);
            if (element) {
              // Hide the original element completely
              const parentDiv = element.closest('.mb-3');
              if (parentDiv) {
                // Save the original label
                const label = parentDiv.querySelector('label');
                const labelText = label ? label.textContent.trim() : field.charAt(0).toUpperCase() + field.slice(1);

                // Clean the div content
                parentDiv.innerHTML = '';

                // Recreate only the label
                const newLabel = document.createElement('label');
                newLabel.className = 'form-label';
                newLabel.textContent = labelText;
                parentDiv.appendChild(newLabel);

                // Add a hidden input to keep the value
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = `id_${field}`;
                hiddenInput.name = field;
                parentDiv.appendChild(hiddenInput);
              }
            }
          });

          // Fill form fields with kit data
          if (kitData.brand) {
            // Handle the new response format
            const brandObj = kitData.brand;
            const brandValue = typeof brandObj === 'object' ? brandObj.name : brandObj;

            // Save the brand name in the hidden input brand_name
            const brandNameField = document.getElementById('id_brand_name');
            if (brandNameField) {
              brandNameField.value = brandValue;
            }

            // Try to find the brand in the existing options
            const found = this.setSelectValueByText('id_brand', brandValue);

            // If the brand is not found, show the value in the field
            if (!found) {
              this.displayFieldValue('brand', brandValue);
            }

            // Save additional information if available
            if (typeof brandObj === 'object' && brandObj.id) {
              // We could save the API ID for future reference
              console.log(`Brand ID from API: ${brandObj.id}`);
            }
          }

          if (kitData.team || kitData.club) {
            // Handle the new format where the club can be in team or club
            const clubObj = kitData.team || kitData.club;
            const clubValue = typeof clubObj === 'object' ? clubObj.name : clubObj;

            // Save the club name in the hidden input club_name
            const clubNameField = document.getElementById('id_club_name');
            if (clubNameField) {
              clubNameField.value = clubValue;
            }

            // Try to find the club in the existing options
            const found = this.setSelectValueByText('id_club', clubValue);

            // If the club is not found, show the value in the field
            if (!found) {
              this.displayFieldValue('club', clubValue);
            }

            // Save additional information if available
            if (typeof clubObj === 'object' && clubObj.id) {
              // We could save the API ID for future reference
              console.log(`Club ID from API: ${clubObj.id}`);
            }
          }

          if (kitData.season) {
            // Handle the new format of season
            const seasonObj = kitData.season;
            const seasonValue = typeof seasonObj === 'object' ?
              seasonObj.year || seasonObj.name :
              seasonObj;

            // Save the season name in the hidden input season_name
            const seasonNameField = document.getElementById('id_season_name');
            if (seasonNameField) {
              seasonNameField.value = seasonValue;
            }

            // Try to find the season in the existing options
            const found = this.setSelectValueByText('id_season', seasonValue);

            // If the season is not found, show the value in the field
            if (!found) {
              this.displayFieldValue('season', seasonValue);
            }

            // Save additional information if available
            if (typeof seasonObj === 'object' && seasonObj.id) {
              // We could save the API ID for future reference
              console.log(`Season ID from API: ${seasonObj.id}`);
            }
          }

          if (kitData.competition) {
            // DEBUG: Log competition processing
            console.log('Processing competition data:', kitData.competition);

            // Handle the new format of competition (can be an array or an object)
            let competitionValue = '';
            let allCompetitions = [];

            if (Array.isArray(kitData.competition) && kitData.competition.length > 0) {
              console.log('Competition is an array with length:', kitData.competition.length);
              // If it's an array, use the first competition as the main one
              const competitionObj = kitData.competition[0];
              competitionValue = typeof competitionObj === 'object' ? competitionObj.name : competitionObj;

              // Save all competitions
              allCompetitions = kitData.competition.map(c => typeof c === 'object' ? c.name : c);
              console.log('Mapped competition names:', allCompetitions);

              // Hide the competition selector and show the competitions as text
              const competitionDiv = document.getElementById('div_id_competitions');
              if (competitionDiv) {
                // Clean the div
                competitionDiv.innerHTML = '';

                // Create the label
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = 'Competitions';
                competitionDiv.appendChild(label);

                // Create the list of competitions
                const competitionList = document.createElement('div');
                competitionList.className = 'form-control-plaintext';
                competitionList.innerHTML = allCompetitions.map(comp => `<div>${comp}</div>`).join('');
                competitionDiv.appendChild(competitionList);

                // Add hidden inputs for each competition
                allCompetitions.forEach(comp => {
                  const hiddenInput = document.createElement('input');
                  hiddenInput.type = 'hidden';
                  hiddenInput.name = 'competitions';
                  hiddenInput.value = comp;
                  competitionDiv.appendChild(hiddenInput);
                });

                // Save the main competition
                const competitionNameField = document.getElementById('id_competition_name');
                if (competitionNameField) {
                  competitionNameField.value = competitionValue;
                }

                // Save all competitions
                const allCompetitionsField = document.createElement('input');
                allCompetitionsField.type = 'hidden';
                allCompetitionsField.id = 'id_all_competitions';
                allCompetitionsField.name = 'all_competitions';
                allCompetitionsField.value = allCompetitions.join(',');
                competitionDiv.appendChild(allCompetitionsField);
              }
            } else if (typeof kitData.competition === 'object') {
              console.log('Competition is a single object:', kitData.competition);
              competitionValue = kitData.competition.name;
              allCompetitions = [competitionValue];
            } else {
              console.log('Competition is a primitive value:', kitData.competition);
              competitionValue = kitData.competition;
              allCompetitions = [competitionValue];
            }

            // DEBUG: Log final competition values
            console.log('Final competition values:', {
              main: competitionValue,
              all: allCompetitions
            });

            // Save the competition name in the hidden input competition_name
            const competitionNameField = document.getElementById('id_competition_name');
            if (competitionNameField) {
              competitionNameField.value = competitionValue;
              console.log('Set competition_name field to:', competitionValue);
            }

            // Try to find the competition in the existing options
            const found = this.setSelectValueByText('id_competition', competitionValue);
            console.log('Competition found in select options:', found);

            // If the competition is not found, show the value in the field
            if (!found) {
              this.displayFieldValue('competition', competitionValue);
              console.log('Displayed competition value:', competitionValue);
            }

            // Show all competitions if there are more than one
            if (allCompetitions.length > 1) {
              const competitionDisplay = document.getElementById('div_id_competition');
              if (competitionDisplay) {
                const allCompetitionsDisplay = document.createElement('div');
                allCompetitionsDisplay.className = 'text-muted small mt-1';
                allCompetitionsDisplay.textContent = `All competitions: ${allCompetitions.join(', ')}`;
                competitionDisplay.appendChild(allCompetitionsDisplay);
                console.log('Added all competitions display');
              }
            }
          }

          // Colors
          console.log('Debugging color data:', {
            primary_color: kitData.primary_color,
            main_color: kitData.main_color,
            secondary_color: kitData.secondary_color
          });

          if (kitData.primary_color || kitData.main_color) {
            // Handle both formats
            const color = kitData.primary_color || kitData.main_color;
            let colorValue = typeof color === 'object' ? color.name : color;

            // Map API color names to our color values (UPPERCASE)
            const colorMapping = {
              'red': 'RED',
              'blue': 'BLUE',
              'white': 'WHITE',
              'black': 'BLACK',
              'yellow': 'YELLOW',
              'green': 'GREEN',
              'orange': 'ORANGE',
              'purple': 'PURPLE',
              'pink': 'PINK',
              'brown': 'BROWN',
              'grey': 'GRAY',
              'gray': 'GRAY',
              'maroon': 'CLARET',
              'gold': 'GOLD',
              'light blue': 'SKY_BLUE',
              'light-blue': 'SKY_BLUE',
              'sky blue': 'SKY_BLUE',
              'sky-blue': 'SKY_BLUE',
              'off white': 'OFF_WHITE',
              'off-white': 'OFF_WHITE',
              'dark blue': 'NAVY',
              'dark-blue': 'NAVY',
              'light grey': 'GRAY',
              'light-grey': 'GRAY'
            };

            // Normalize the color value
            console.log('Original color value:', colorValue);
            colorValue = colorMapping[colorValue.toLowerCase()] || colorValue.toUpperCase();
            console.log('Mapped color value:', colorValue);

            // Update the value in the Cotton component
            updateCottonComponent('main_color', colorValue);

            // For colors, we don't create new ones since they are predefined values
            if (!this.setSelectValue('id_main_color', colorValue)) {
              console.log(`Main color "${colorValue}" not found in available options. Using default value.`);
            }
          }

          // Secondary colors
          const secondaryColors = kitData.secondary_color || kitData.secondary_colors;
          console.log('Debugging secondary colors:', secondaryColors);

          // Only process if secondaryColors exists and is not an empty array
          if (secondaryColors && !(Array.isArray(secondaryColors) && secondaryColors.length === 0)) {
            let selectedColors = [];

            // Map API color names to our color values (UPPERCASE)
            const colorMapping = {
              'red': 'RED',
              'blue': 'BLUE',
              'white': 'WHITE',
              'black': 'BLACK',
              'yellow': 'YELLOW',
              'green': 'GREEN',
              'orange': 'ORANGE',
              'purple': 'PURPLE',
              'pink': 'PINK',
              'brown': 'BROWN',
              'grey': 'GRAY',
              'gray': 'GRAY',
              'maroon': 'CLARET',
              'gold': 'GOLD',
              'light blue': 'SKY_BLUE',
              'light-blue': 'SKY_BLUE',
              'sky blue': 'SKY_BLUE',
              'sky-blue': 'SKY_BLUE',
              'off white': 'OFF_WHITE',
              'off-white': 'OFF_WHITE',
              'dark blue': 'NAVY',
              'dark-blue': 'NAVY',
              'light grey': 'GRAY',
              'light-grey': 'GRAY'
            };

            // Verify if it's an array, an object or a string
            if (Array.isArray(secondaryColors) && secondaryColors.length > 0) {
              // It's an array of colors
              secondaryColors.forEach(color => {
                let colorValue = typeof color === 'object' ? color.name : color;
                // Normalize the color value
                colorValue = colorMapping[colorValue.toLowerCase()] || colorValue.toUpperCase();
                selectedColors.push(colorValue);
              });
            } else if (typeof secondaryColors === 'object' && secondaryColors !== null && !Array.isArray(secondaryColors)) {
              // It's an object with a single color (but not an array)
              let colorValue = secondaryColors.name || secondaryColors.toString();
              // Normalize the color value
              colorValue = colorMapping[colorValue.toLowerCase()] || colorValue.toUpperCase();
              selectedColors.push(colorValue);
            } else if (typeof secondaryColors === 'string' && secondaryColors.trim() !== '') {
              // It's a string
              let colorValue = secondaryColors;
              // Normalize the color value
              colorValue = colorMapping[colorValue.toLowerCase()] || colorValue.toUpperCase();
              selectedColors.push(colorValue);
            }

            // Update the value in the Cotton component
            if (selectedColors.length > 0) {
              updateCottonComponent('secondary_colors', selectedColors);
            }
          } else if (Array.isArray(secondaryColors) && secondaryColors.length === 0) {
            // Explicitly handle empty array - clear secondary colors
            console.log('Secondary colors is empty array, clearing selection');
            updateCottonComponent('secondary_colors', []);
          }

          // Design
          console.log('Debugging design data:', kitData.design);

          if (kitData.design) {
            let designValue = typeof kitData.design === 'object' ? kitData.design.name : kitData.design;

            // Map API design names to our design values
            const designMapping = {
              'plain': 'PLAIN',
              'stripes': 'STRIPES',
              'graphic': 'GRAPHIC',
              'chest band': 'CHEST_BAND',
              'chest-band': 'CHEST_BAND',
              'chest_band': 'CHEST_BAND',
              'contrasting sleeves': 'CONTRASTING_SLEEVES',
              'contrasting-sleeves': 'CONTRASTING_SLEEVES',
              'contrasting_sleeves': 'CONTRASTING_SLEEVES',
              'pinstripes': 'PINSTRIPES',
              'hoops': 'HOOPS',
              'single stripe': 'SINGLE_STRIPE',
              'single-stripe': 'SINGLE_STRIPE',
              'single_stripe': 'SINGLE_STRIPE',
              'half and half': 'HALF_AND_HALF',
              'half-and-half': 'HALF_AND_HALF',
              'half_and_half': 'HALF_AND_HALF',
              'sash': 'SASH',
              'chevron': 'CHEVRON',
              'checkers': 'CHECKERS',
              'gradient': 'GRADIENT',
              'diagonal': 'DIAGONAL',
              'cross': 'CROSS',
              'quarters': 'QUARTERS'
            };

            // Normalize the design value
            designValue = designMapping[designValue.toLowerCase()] || designValue.toUpperCase();

            console.log('Processing design:', designValue);

            // Update the value in the Cotton component
            updateCottonComponent('design', designValue);

            // For designs, we don't create new ones since they are predefined values
            if (!this.setSelectValue('id_design', designValue)) {
              console.log(`Design "${designValue}" not found in available options. Using default value.`);
            }
          }

          // Type (Home, Away, Third, etc.)
          if (kitData.type && kitData.type.name) {
            const typeValue = kitData.type.name;
            const found = this.setSelectValueByText('id_kit_type', typeValue);

            // If kit type not found, create it dynamically
            if (!found) {
              console.log(`El tipo de kit "${typeValue}" no se encontr√≥. Creando opci√≥n din√°micamente...`);
              this.createKitTypeOption(typeValue);
            }

            // Mostrar el valor en el campo
            this.displayFieldValue('kit_type', typeValue);
          }

          // Other fields
          if (kitData.is_replica !== undefined) {
            document.getElementById('id_is_replica').checked = kitData.is_replica;
          }

          if (kitData.team && kitData.team.country) {
            console.log('Setting country code to:', kitData.team.country);

            // Update the select2 dropdown with proper country data
            const countrySelect = $('#id_country_code');
            if (countrySelect.length) {
              // First, fetch ALL countries to populate the dropdown
              fetch('/core/country-autocomplete/')
                .then(response => response.json())
                .then(data => {
                  // Clear existing options
                  countrySelect.empty();

                  // Add all countries to the dropdown
                  data.results.forEach(country => {
                    // Create option element manually to avoid HTML escaping
                    const option = document.createElement('option');
                    option.value = country.id;
                    option.innerHTML = country.text; // Use innerHTML to render HTML
                    countrySelect.append(option);
                  });

                  // Re-initialize select2 with proper template functions using django.jQuery
                  if (countrySelect.hasClass('select2-hidden-accessible')) {
                    countrySelect.select2('destroy');
                  }

                  countrySelect.select2({
                    theme: 'bootstrap5',
                    width: '100%',
                    placeholder: 'Select a country...',
                    allowClear: true,
                    templateResult: function(country) {
                      if (!country.id) return country.text;
                      // Return the HTML as a jQuery object
                      return $('<span>' + country.text + '</span>');
                    },
                    templateSelection: function(country) {
                      if (!country.id) return country.text;
                      // Return the HTML as a jQuery object
                      return $('<span>' + country.text + '</span>');
                    },
                    escapeMarkup: function(markup) {
                      // Don't escape HTML, allow it to render
                      return markup;
                    }
                  });

                  // Clear any default selection
                  countrySelect.val(null).trigger('change');

                  // Select the country from the API
                  countrySelect.val(kitData.team.country).trigger('change');
                  console.log('All countries loaded and selected with proper rendering:', kitData.team.country);
                })
                .catch(error => {
                  console.error('Error fetching countries:', error);
                  // Fallback: just set the value
                  countrySelect.val(kitData.team.country).trigger('change');
                });
            }
          }

          // Save the main image if it exists
          if (kitData.main_img_url) {
            // Here you could save the image URL to display it or process it later
            console.log('Imagen principal del kit:', kitData.main_img_url);
            // Set the value in the hidden input of the form
            const imgUrlField = document.getElementById('id_main_img_url');
            if (imgUrlField) {
              imgUrlField.value = kitData.main_img_url;
            }

            // Show the image in the photos section
            this.displayMainImage(kitData.main_img_url);
          }

          // Hide the search section after selecting a kit
          try {
            const searchCard = document.querySelector('.card-header h5.card-title');
            if (searchCard && searchCard.closest('.card') && searchCard.textContent.includes('Search')) {
              searchCard.closest('.card').style.display = 'none';
            }
          } catch (error) {
            console.error('Error al ocultar la tarjeta de b√∫squeda:', error);
          }
        },

        // Helper method to create kit type option dynamically
        createKitTypeOption(typeValue) {
          const selectElement = document.getElementById('id_kit_type');
          if (selectElement) {
            const option = document.createElement('option');
            option.value = typeValue;
            option.textContent = typeValue;
            selectElement.appendChild(option);
            console.log(`Kit type option "${typeValue}" created successfully`);
          }
        },

        // Method to show the value of a field
        displayFieldValue(fieldName, value, isColor = false) {
          const fieldContainer = document.getElementById(`div_id_${fieldName}`);
          if (!fieldContainer) {
            console.warn(`No se encontr√≥ el contenedor para el campo ${fieldName}`);

            // For kit_type specifically, try to find it with a different approach
            if (fieldName === 'kit_type') {
              // Try to find the field by its input ID instead
              const inputField = document.getElementById(`id_${fieldName}`);
              if (inputField) {
                // If we found the input, get its parent container
                const parentDiv = inputField.closest('.mb-3');
                if (parentDiv) {
                  // Set the value directly on the input
                  inputField.value = value;
                  console.log(`Campo ${fieldName} actualizado directamente con valor: ${value}`);
                  return;
                }
              }
            }
            return;
          }

          try {
            // For the Cotton components (main_color, secondary_colors, design), we don't show the value directly
            // since the components have their own display
            if (fieldName === 'main_color' || fieldName === 'secondary_colors' || fieldName === 'design') {
              // Only update the value of the hidden input
              const hiddenInput = document.getElementById(`id_${fieldName}`);
              if (hiddenInput) {
                if (Array.isArray(value)) {
                  // For multiple selects, we need to select the options
                  if (hiddenInput.options && hiddenInput.options.length > 0) {
                    for (let i = 0; i < hiddenInput.options.length; i++) {
                      hiddenInput.options[i].selected = value.includes(hiddenInput.options[i].text);
                    }
                  } else {
                    // If it doesn't have options, set the value as a string
                    hiddenInput.value = value.join(',');
                  }
                }
              }
              return;
            }

            // Remove any previous display or confirmation message
            const existingDisplays = fieldContainer.querySelectorAll('.form-control.p-2.bg-light, .text-success, .form-control.p-2.border');
            existingDisplays.forEach(el => el.remove());

            // Create the element to show the value
            const valueDisplay = document.createElement('div');
            valueDisplay.className = 'form-control p-2 border rounded';

            if (isColor) {
              // If it's a color, show a swatch
              if (Array.isArray(value)) {
                // For multiple colors
                valueDisplay.innerHTML = value.map(color =>
                  `<span class="color-swatch" style="background-color: ${this.getColorCode(color)};"></span> ${color}`
                ).join(', ');
              } else {
                // For a single color
                valueDisplay.innerHTML = `<span class="color-swatch" style="background-color: ${this.getColorCode(value)};"></span> ${value}`;
              }
            } else {
              // For other fields
              valueDisplay.textContent = value;
            }

            // Add to the container
            fieldContainer.appendChild(valueDisplay);

            // Update the value of the hidden input
            const hiddenInput = document.getElementById(`id_${fieldName}`);
            if (hiddenInput) {
              if (Array.isArray(value)) {
                // For multiple selects, we need to select the options
                if (hiddenInput.options && hiddenInput.options.length > 0) {
                  for (let i = 0; i < hiddenInput.options.length; i++) {
                    hiddenInput.options[i].selected = value.includes(hiddenInput.options[i].text);
                  }
                } else {
                  hiddenInput.value = value;
                }
              }
            }
          } catch (error) {
            console.error(`Error al mostrar el valor del campo ${fieldName}:`, error);
          }
        },

        // Method to get the color code from the name
        getColorCode(colorName) {
          // Basic color map
          const colorMap = {
            'red': '#ff0000',
            'blue': '#0000ff',
            'green': '#008000',
            'yellow': '#ffff00',
            'orange': '#ffa500',
            'purple': '#800080',
            'pink': '#ffc0cb',
            'brown': '#a52a2a',
            'black': '#000000',
            'white': '#ffffff',
            'gray': '#808080',
            'grey': '#808080',
            'gold': '#ffd700',
            'silver': '#c0c0c0',
            'navy': '#000080',
            'aqua': '#00ffff',
            'teal': '#008080',
            'maroon': '#800000',
            'lime': '#00ff00',
            'olive': '#808000',
            'cyan': '#00ffff',
            'magenta': '#ff00ff',
            'beige': '#f5f5dc',
            'ivory': '#fffff0',
            'lavender': '#e6e6fa',
            'turquoise': '#40e0d0',
            'violet': '#ee82ee',
            'indigo': '#4b0082',
            'crimson': '#dc143c',
            'azure': '#f0ffff',
            'coral': '#ff7f50',
            'khaki': '#f0e68c',
            'salmon': '#fa8072',
            'sienna': '#a0522d',
            'tan': '#d2b48c',
            'tomato': '#ff6347',
            'wheat': '#f5deb3',
            'plum': '#dda0dd',
            'orchid': '#da70d6',
            'thistle': '#d8bfd8',
            'skyblue': '#87ceeb',
            'royalblue': '#4169e1',
            'steelblue': '#4682b4',
            'darkblue': '#00008b',
            'darkgreen': '#006400',
            'darkred': '#8b0000',
            'darkgray': '#a9a9a9',
            'darkgrey': '#a9a9a9',
            'lightblue': '#add8e6',
            'lightgreen': '#90ee90',
            'lightred': '#ffcccb',
            'lightgray': '#d3d3d3',
            'lightgrey': '#d3d3d3'
          };

          // Convert to lowercase and search in the map
          const lowerColorName = colorName.toLowerCase();

          // Search for exact matches first
          if (colorMap[lowerColorName]) {
            return colorMap[lowerColorName];
          }

          // If there is no exact match, search for partial matches
          for (const [key, value] of Object.entries(colorMap)) {
            if (lowerColorName.includes(key) || key.includes(lowerColorName)) {
              return value;
            }
          }

          // If there is no match, return a default color
          return '#cccccc';
        },

        // Method to create a new option in a selector
        createNewOption(selectId, text, entityType) {
          try {
            const select = document.getElementById(selectId);
            if (!select) {
              console.warn(`No se encontr√≥ el elemento select con ID ${selectId}`);
              return false;
            }

            // Verify if there is already an option "create_new"
            let createOption = null;

            // Verify if the select has options before iterating
            if (select.options && select.options.length > 0) {
              for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === 'create_new') {
                  createOption = select.options[i];
                  break;
                }
              }
            }

            // If it doesn't exist, create the option hidden
            if (!createOption) {
              createOption = document.createElement('option');
              createOption.value = 'create_new';
              createOption.style.display = 'none'; // Hide the option
              createOption.dataset.entityType = entityType;
              createOption.dataset.entityName = text;
              select.appendChild(createOption);
            } else {
              // Update the data of the existing option
              createOption.dataset.entityName = text;
            }

            // Update the hidden field with the name of the entity
            const hiddenFieldId = `id_${entityType}_name`;
            let hiddenField = document.getElementById(hiddenFieldId);
            if (hiddenField) {
              hiddenField.value = text;
            } else {
              // If it doesn't exist, create the field
              const newHiddenField = document.createElement('input');
              newHiddenField.type = 'hidden';
              newHiddenField.id = hiddenFieldId;
              newHiddenField.name = `${entityType}_name`;
              newHiddenField.value = text;
              document.getElementById('jersey-form').appendChild(newHiddenField);
            }

            // Select the option "create_new"
            select.value = 'create_new';

            // Trigger change event
            const event = new Event('change', {
              bubbles: true
            });
            select.dispatchEvent(event);

            // Show a confirmation message
            console.log(`Campo ${entityType}_name configurado con valor: ${text}`);

            return true;
          } catch (error) {
            console.error(`Error al crear nueva opci√≥n para ${entityType}:`, error);
            return false;
          }
        },

        // Method to show the main image in the photos section
        displayMainImage(imageUrl) {
          if (!imageUrl) return;

          console.log('Mostrando imagen principal:', imageUrl);

          try {
            // Remove previous previews
            const existingPreviews = document.querySelectorAll('.api-image-preview');
            existingPreviews.forEach(preview => preview.remove());

            // Create an element to show the image
            const imagePreview = document.createElement('div');
            imagePreview.className = 'card mb-3 api-image-preview';
            imagePreview.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            imagePreview.style.border = '1px solid var(--fc-border)';
            imagePreview.style.backgroundColor = 'var(--fc-card)';
            imagePreview.style.borderRadius = '0.5rem';
            imagePreview.innerHTML = `
            <div class="card-header" style="background-color: hsla(180, 85%, 40%, 1); color: white; border-bottom: 1px solid var(--fc-border);">
              <h5 class="card-title mb-0">Kit Image</h5>
            </div>
            <div class="card-body text-center" style="background-color: var(--fc-card); padding: 1.5rem;">
              <img src="${imageUrl}" alt="Kit Image" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 0.5rem;" class="mb-2" />
              <p class="mb-0 small" style="color: var(--fc-muted-foreground);">This image will be automatically downloaded once the jersey is created</p>
            </div>
          `;

            // Find the jersey details card
            let jerseyDetailsCard = null;
            const cardHeaders = document.querySelectorAll('.card-header');

            // Try to find the jersey details card
            for (let i = 0; i < cardHeaders.length; i++) {
              const titleElement = cardHeaders[i].querySelector('h5.card-title');
              if (titleElement && titleElement.textContent.includes('Jersey Details')) {
                jerseyDetailsCard = cardHeaders[i].closest('.card');
                break;
              }
            }

            if (jerseyDetailsCard) {
              // Insert before the details card
              jerseyDetailsCard.parentNode.insertBefore(imagePreview, jerseyDetailsCard);
            } else {
              // As an alternative, insert it after the first card (which should be the search card)
              const firstCard = document.querySelector('.card');
              if (firstCard) {
                firstCard.parentNode.insertBefore(imagePreview, firstCard.nextSibling);
              } else {
                // As an alternative, insert it at the beginning of the form
                const form = document.getElementById('jersey-form');
                if (form) {
                  form.insertBefore(imagePreview, form.firstChild);
                }
              }
            }

            // Ensure the image is visible by scrolling to it
            setTimeout(() => {
              imagePreview.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
              });
            }, 500);
          } catch (error) {
            console.error('Error al mostrar la imagen principal:', error);
            // As an alternative, insert it at the beginning of the form
            try {
              const form = document.getElementById('jersey-form');
              if (form) {
                const imagePreview = document.createElement('div');
                imagePreview.className = 'card mb-3 api-image-preview';
                imagePreview.style.border = '1px solid var(--fc-border)';
                imagePreview.style.backgroundColor = 'var(--fc-card)';
                imagePreview.style.borderRadius = '0.5rem';
                imagePreview.innerHTML = `
                <div class="card-header" style="background-color: hsla(180, 85%, 40%, 1); color: white; border-bottom: 1px solid var(--fc-border);">
                  <h5 class="card-title mb-0">Kit Image</h5>
                </div>
                <div class="card-body text-center" style="background-color: var(--fc-card); padding: 1.5rem;">
                  <img src="${imageUrl}" alt="Kit Image" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 0.5rem;" class="mb-2" />
                  <p class="mb-0 small" style="color: var(--fc-muted-foreground);">This image will be automatically downloaded once the jersey is created</p>
                </div>
              `;
                form.insertBefore(imagePreview, form.firstChild);
              }
            } catch (innerError) {
              console.error('Error al intentar mostrar la imagen como √∫ltimo recurso:', innerError);
            }
          }
        },

        // Original method to search by exact value
        setSelectValue(selectId, value) {
          const select = document.getElementById(selectId);
          if (select) {
            // Verify if the value exists in the options
            let valueExists = false;
            for (let i = 0; i < select.options.length; i++) {
              if (select.options[i].value == value) {
                valueExists = true;
                break;
              }
            }

            if (valueExists) {
              select.value = value;

              // Trigger change event to activate any listener
              const event = new Event('change', {
                bubbles: true
              });
              select.dispatchEvent(event);
            } else {
              console.warn(`Value ${value} not found in select ${selectId}`);
            }
          }
        },

        // New method to search by text/name
        setSelectValueByText(selectId, text) {
          if (!text) return false;

          const select = document.getElementById(selectId);
          if (!select) return false;

          // First try to find an exact match
          let found = this.selectOptionByText(select, text);

          // If we don't find an exact match, try a partial match
          if (!found) {
            found = this.selectOptionByPartialText(select, text);
          }

          // If we still don't find, show a message
          if (!found) {
            console.warn(`No se encontr√≥ ninguna opci√≥n que coincida con "${text}" en el selector ${selectId}`);
          }

          return found;
        },

        // Method to select an option by text
        selectOptionByText(select, text) {
          if (!select || !text) return false;

          try {
            text = text.toString().trim().toLowerCase();
            let found = false;

            if (!select.options || select.options.length === 0) {
              console.warn('El elemento select no tiene opciones');
              return false;
            }

            for (let i = 0; i < select.options.length; i++) {
              const optionText = select.options[i].text.trim().toLowerCase();
              if (optionText === text) {
                select.options[i].selected = true;
                found = true;

                // Trigger change event
                const event = new Event('change', {
                  bubbles: true
                });
                select.dispatchEvent(event);
                break;
              }
            }

            return found;
          } catch (error) {
            console.error(`Error al seleccionar opci√≥n por texto "${text}":`, error);
            return false;
          }
        },

        // Method to select an option by partial text
        selectOptionByPartialText(select, text) {
          if (!select || !text) return false;

          try {
            text = text.toString().trim().toLowerCase();
            let found = false;

            if (!select.options || select.options.length === 0) {
              console.warn('El elemento select no tiene opciones');
              return false;
            }

            // First try to find if the text is contained in any option
            for (let i = 0; i < select.options.length; i++) {
              const optionText = select.options[i].text.trim().toLowerCase();
              if (optionText.includes(text) || text.includes(optionText)) {
                select.options[i].selected = true;
                found = true;

                // Trigger change event
                const event = new Event('change', {
                  bubbles: true
                });
                select.dispatchEvent(event);
                break;
              }
            }

            // If we don't find, try to search for individual words
            if (!found && text.includes(' ')) {
              const words = text.split(' ');
              for (let word of words) {
                if (word.length < 3) continue; // Ignore very short words

                for (let i = 0; i < select.options.length; i++) {
                  const optionText = select.options[i].text.trim().toLowerCase();
                  if (optionText.includes(word)) {
                    select.options[i].selected = true;
                    found = true;

                    // Trigger change event
                    const event = new Event('change', {
                      bubbles: true
                    });
                    select.dispatchEvent(event);
                    break;
                  }
                }

                if (found) break;
              }
            }

            return found;
          } catch (error) {
            console.error(`Error al seleccionar opci√≥n por texto parcial "${text}":`, error);
            return false;
          }
        },

        searchClubs() {
          if (this.clubSearch.length < 3) return;

          // Create a timestamp for this search
          const searchTimestamp = Date.now();
          this.lastClubSearchTimestamp = searchTimestamp;

          this.isSearchingClub = true;
          const url = `/fkapi/clubs/search/?keyword=${encodeURIComponent(this.clubSearch)}`;
          console.log('Searching clubs with URL:', url);

          fetch(url)
            .then(response => {
              console.log('Club search response status:', response.status);
              if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
              }
              return response.json();
            })
            .then(data => {
              // Only update the results if this is the most recent search
              if (searchTimestamp === this.lastClubSearchTimestamp) {
                console.log('Club search results:', data);

                // Ensure the logos are displayed correctly
                if (data.results && Array.isArray(data.results)) {
                  data.results.forEach(club => {
                    // Verify if the club has a logo
                    if (!club.logo) {
                      console.log('Club sin logo:', club.name);
                    }
                    // Ensure logo_url is available
                    if (club.logo && !club.logo_url) {
                      club.logo_url = club.logo;
                    }
                  });
                }

                this.clubResults = data.results || [];
              } else {
                console.log('Ignoring outdated search results');
              }
              this.isSearchingClub = false;
            })
            .catch(error => {
              console.error('Error searching clubs:', error);
              this.isSearchingClub = false;
              // Mostrar un mensaje de error al usuario
              alert('Error al buscar clubs: ' + error.message);
            });
        },

        selectClub(club) {
          this.selectedClub = club;
          this.clubResults = [];
          this.clubSearch = club.name;

          // Save the logo URL to display in the form
          if (club.logo) {
            console.log('Logo URL del club seleccionado:', club.logo);
            // Ensure the club has the logo_url property
            this.selectedClub.logo_url = club.logo;
          }

          // Get club seasons
          const url = `/api/clubs/${club.id}/seasons/`;
          console.log('Getting club seasons with URL:', url);

          fetch(url)
            .then(response => {
              console.log('Club seasons response status:', response.status);
              return response.json();
            })
            .then(data => {
              console.log('Club seasons:', data);
              this.seasons = data.results || [];
            })
            .catch(error => {
              console.error('Error getting club seasons:', error);
            });

          // Update the club field in the form
          this.setSelectValue('id_club', club.id);
        },

        seasonChanged() {
          if (!this.selectedSeasonId || !this.selectedClub) return;

          // Update the season field in the form
          this.setSelectValueByText('id_season', this.selectedSeasonId);

          // Optionally, load kits from this season
          const url = `/api/clubs/${this.selectedClub.id}/seasons/${this.selectedSeasonId}/kits/`;
          console.log('Getting kits for season with URL:', url);

          fetch(url)
            .then(response => {
              console.log('Season kits response status:', response.status);
              if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
              }
              return response.json();
            })
            .then(data => {
              console.log('Kits for this season:', data.results);
            })
            .catch(error => {
              console.error('Error getting kits for season:', error);
              // Mostrar un mensaje de error al usuario
              alert('Error al obtener kits para la temporada: ' + error.message);
            });
        }
      }));
    });

    // ============================================================================
    // SELECT2 DARK THEME - JavaScript Optimizado
    // ============================================================================
    document.addEventListener('DOMContentLoaded', function() {
      // Esperar a que jQuery y Select2 est√©n listos
      if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
        console.warn('jQuery o Select2 no est√°n cargados');
        return;
      }

      // Obtener variables CSS una sola vez
      const getCSSVar = (name, fallback = '') => {
        return getComputedStyle(document.documentElement)
          .getPropertyValue(name)
          .trim() || fallback;
      };

      const colors = {
        secondary: getCSSVar('--fc-secondary', '#1a1a1a'),
        card: getCSSVar('--fc-card', '#0f0f0f'),
        border: getCSSVar('--fc-border', '#333333'),
        foreground: getCSSVar('--fc-foreground', '#f0f0f0'),
        primary: getCSSVar('--fc-primary', '#32b8c6'),
        mutedForeground: getCSSVar('--fc-muted-foreground', '#888888'),
      };

      // Funci√≥n para aplicar estilos inline (fallback)
      const applyInlineStyles = ($element) => {
        if (!$element || !$element.length) return;

        // Selection box
        if ($element.hasClass('select2-selection')) {
          $element.css({
            'background-color': colors.secondary,
            'border-color': colors.border,
            'color': colors.foreground,
          });

          // Rendered text
          $element.find('.select2-selection__rendered').css({
            'color': colors.foreground,
            'display': 'flex',
            'align-items': 'center',
            'height': '100%',
            'padding-right': '30px',
          });

          // Style choice tags/chips
          $element.find('.select2-selection__choice').each(function() {
            const $choice = $(this);
            $choice.css({
              'background-color': colors.secondary,
              'border-color': colors.border,
              'color': colors.foreground,
              'padding': '2px 6px',
              'margin': '2px 4px 2px 0',
              'border-radius': '4px',
              'display': 'inline-flex',
              'align-items': 'center',
              'line-height': '1.4',
              'max-width': '100%',
            });

            // Style remove button
            $choice.find('.select2-selection__choice__remove').css({
              'color': colors.mutedForeground,
              'margin-right': '4px',
              'margin-left': '0',
              'padding': '0 2px',
              'font-size': '16px',
              'line-height': '1',
              'height': 'auto',
              'width': 'auto',
            });
          });

          // Arrow
          const $arrow = $element.find('.select2-selection__arrow b');
          const $container = $element.closest('.select2-container--bootstrap5');
          const isOpen = $container && $container.hasClass('select2-container--open');

          if (isOpen) {
            $arrow.css({
              'border-color': `transparent transparent ${colors.foreground} transparent`,
            });
          } else {
            $arrow.css({
              'border-color': `${colors.foreground} transparent transparent transparent`,
            });
          }
        }

        // Dropdown
        if ($element.hasClass('select2-dropdown')) {
          $element.css({
            'background-color': colors.card,
            'border-color': colors.border,
            'color': colors.foreground,
          });

          // Search field
          $element.find('.select2-search__field').css({
            'background-color': colors.secondary,
            'border-color': colors.border,
            'color': colors.foreground,
          });

          // Options
          $element.find('.select2-results__option').each(function() {
            const $option = $(this);
            $option.css({
              'background-color': colors.card,
              'color': colors.foreground,
            });

            if ($option.hasClass('select2-results__option--highlighted')) {
              $option.css('background-color', 'rgba(50, 184, 198, 0.2)');
            }

            if ($option.attr('aria-selected') === 'true') {
              $option.css('background-color', 'rgba(50, 184, 198, 0.15)');
            }
          });
        }
      };

      // Inicializar Select2 para el campo country
      const $countrySelect = $('#id_country_code');

      if ($countrySelect.length) {
        // Aplicar estilos despu√©s de que Select2 se inicialice
        setTimeout(() => {
          const $container = $countrySelect.next('.select2-container');
          if ($container.length) {
            applyInlineStyles($container.find('.select2-selection'));
          }
        }, 50);

        // Aplicar estilos cuando se abre el dropdown
        $countrySelect.on('select2:open', function() {
          setTimeout(() => {
            const $dropdown = $('.select2-dropdown');
            if ($dropdown.length) {
              applyInlineStyles($dropdown);
            }
            // Tambi√©n actualizar el contenedor
            const $container = $countrySelect.next('.select2-container');
            if ($container.length) {
              applyInlineStyles($container.find('.select2-selection'));
            }
          }, 10);
        });

        // Aplicar estilos cuando se cierra
        $countrySelect.on('select2:close', function() {
          const $container = $countrySelect.next('.select2-container');
          if ($container.length) {
            applyInlineStyles($container.find('.select2-selection'));
          }
        });

        // Aplicar estilos cuando se selecciona un valor
        $countrySelect.on('select2:select select2:unselect', function() {
          setTimeout(() => {
            const $container = $countrySelect.next('.select2-container');
            if ($container.length) {
              applyInlineStyles($container.find('.select2-selection'));
            }
          }, 10);
        });
      }

      // MutationObserver como fallback (menos agresivo)
      let observerTimeout;
      const observer = new MutationObserver(function(mutations) {
        // Debounce para evitar ejecutar m√∫ltiples veces
        clearTimeout(observerTimeout);
        observerTimeout = setTimeout(() => {
          const $container = $('#id_country_code').next('.select2-container');
          const $dropdown = $('.select2-dropdown:visible');

          if ($container.length) {
            applyInlineStyles($container.find('.select2-selection'));
          }
          if ($dropdown.length) {
            applyInlineStyles($dropdown);
          }
        }, 10);
      });

      // Observar solo cambios de clase (m√°s eficiente)
      observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style'],
        subtree: true,
      });

      console.log('‚úÖ Select2 dark theme initialized');
    });
  </script>
{% endblock inline_javascript %}
{% block content %}
  <div x-data="jerseyForm" x-init="init()" class="fc-container-centered">
    <h2 class="mb-4 fc-title-large">{% trans "Add Jersey from Database" %}</h2>
    {% if messages %}
      <div class="messages">
        {% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}
      </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data" id="jersey-form">
      {% csrf_token %}
      <div class="fc-card mb-4">
        <div class="fc-card-header-small">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Search" %}</h5>
        </div>
        <div class="fc-card-body-small fc-card-body-flex">
          <!-- Kit Search -->
          <div class="mb-3 position-relative">
            <label for="id_kit_search" class="form-label">{% trans "Search for a Kit" %}</label>
            <div class="input-group position-relative">
              <input type="text"
                     id="id_kit_search"
                     name="kit_search"
                     class="form-control"
                     placeholder="{% trans 'Enter at least 3 characters' %}"
                     x-model="kitSearch"
                     autocomplete="off"
                     class="fc-form-input fc-form-input-with-icon" />
              <div class="loading-indicator" x-show="isSearching" x-cloak>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </div>
            </div>
            <!-- Kit Search Results -->
            <div class="kit-search-results" x-show="kitResults.length > 0">
              <div class="p-2 border-bottom fc-photo-placeholder fc-photo-placeholder-border">
                <small class="fc-text-small">{% trans "Results for" %}: <span x-text="kitSearch"></span></small>
                <button type="button" class="btn-close float-end" @click="kitResults = []" aria-label="Close"></button>
              </div>
              <template x-for="kit in kitResults" :key="kit.id">
                <div class="kit-search-item" @click="selectKit(kit)">
                  <div class="kit-search-item-img-container">
                    <template x-if="kit.main_img_url">
                      <img :src="kit.main_img_url" :alt="kit.name" @error="handleImageError($el)" loading="lazy" class="kit-search-img" />
                    </template>
                    <template x-if="!kit.main_img_url">
                      <div class="placeholder-img">
                        <i class="bi bi-image"></i>
                      </div>
                    </template>
                  </div>
                  <div>
                    <div x-text="kit.name" class="fw-bold"></div>
                    <small class="text-muted" x-text="kit.team_name + ' - ' + kit.season_year"></small>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <!-- Or search by club -->
          <div class="mb-3" x-show="showClubSearch">
            <p class="text-center">{% trans "Or" %}</p>
            <label for="id_club_search" class="form-label">{% trans "Search for a Club" %}</label>
            <div class="input-group position-relative">
              <input type="text"
                     id="id_club_search"
                     name="club_search"
                     class="form-control"
                     placeholder="{% trans 'Enter at least 3 characters' %}"
                     x-model="clubSearch"
                     autocomplete="off"
                     class="fc-form-input fc-form-input-with-icon" />
              <div class="loading-indicator" x-show="isSearchingClub" x-cloak>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </div>
            </div>
            <!-- Club Search Results -->
            <div class="kit-search-results" x-show="clubResults.length > 0">
              <div class="p-2 border-bottom fc-photo-placeholder fc-photo-placeholder-border">
                <small class="fc-text-small">{% trans "Results for" %}: <span x-text="clubSearch"></span></small>
                <button type="button" class="btn-close float-end" @click="clubResults = []" aria-label="Close"></button>
              </div>
              <template x-for="club in clubResults" :key="club.id">
                <div class="kit-search-item" @click="selectClub(club)">
                  <div class="kit-search-item-img-container">
                    <template x-if="club.logo_url">
                      <img :src="club.logo_url" :alt="club.name" @error="handleImageError($el)" loading="lazy" class="kit-search-img" />
                    </template>
                    <template x-if="!club.logo_url">
                      <div class="placeholder-img">
                        <i class="bi bi-image"></i>
                      </div>
                    </template>
                  </div>
                  <div>
                    <div x-text="club.name" class="fw-bold"></div>
                    <small class="text-muted" x-text="club.country || ''"></small>
                  </div>
                </div>
              </template>
            </div>
          </div>
          <!-- Season Selection (shows after club is selected) -->
          <div class="mb-3" x-show="showClubSearch && selectedClub && seasons.length > 0">
            <label for="id_season_select" class="form-label">{% trans "Select Season" %}</label>
            <div class="d-flex align-items-center mb-2" x-show="selectedClub">
              <template x-if="selectedClub && selectedClub.logo_url">
                <img :src="selectedClub.logo_url" :alt="selectedClub.name" class="selected-club-logo" />
              </template>
              <span class="fw-bold" x-text="selectedClub ? selectedClub.name : ''"></span>
            </div>
            <select id="id_season_select" class="form-select" x-model="selectedSeasonId" @change="seasonChanged()">
              <option value="">{% trans "Select a season" %}</option>
              <template x-for="season in seasons" :key="season.id">
                <option :value="season.id" x-text="season.name"></option>
              </template>
            </select>
          </div>
        </div>
      </div>
      <!-- Form Fields -->
      <div class="fc-card mb-4">
        <div class="fc-card-header-small">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Jersey Details" %}</h5>
        </div>
        <div class="fc-card-body-flex">
          <!-- Read-only info section (Brand, Competitions, Club, Season) -->
          <div class="row mb-4 fc-photo-placeholder fc-photo-placeholder-rounded" x-show="kitData" x-cloak>
            <div class="col-md-3 mb-2 mb-md-0">
              <div class="text-muted small mb-1">{% trans "Brand" %}</div>
              <div class="fw-semibold" x-text="kitData?.brand?.name || kitData?.team?.brand?.name"></div>
            </div>
            <div class="col-md-3 mb-2 mb-md-0">
              <div class="text-muted small mb-1">{% trans "Competitions" %}</div>
              <div class="fw-semibold">
                <template x-for="comp in kitData?.competition" :key="comp.id">
                  <div x-text="comp.name"></div>
                </template>
              </div>
            </div>
            <div class="col-md-3 mb-2 mb-md-0">
              <div class="text-muted small mb-1">{% trans "Club" %}</div>
              <div class="fw-semibold" x-text="kitData?.team?.name"></div>
            </div>
            <div class="col-md-3 mb-2 mb-md-0">
              <div class="text-muted small mb-1">{% trans "Season" %}</div>
              <div class="fw-semibold" x-text="kitData?.season?.year"></div>
            </div>
          </div>
          <!-- Cotton Components for colors and design -->
          <div class="row mb-3">
            <div class="col-md-6" id="div_id_main_color">
              <c-color-selector name="main_color" label="{% trans 'Main Color' %}" data-selected="{{ form.main_color.value|default:'' }}" :color_choices="{{ color_choices|safe }}">
              </c-color-selector>
            </div>
            <div class="col-md-6" id="div_id_secondary_colors">
              <c-color-selector name="secondary_colors" label="{% trans 'Secondary Colors' %}" data-multiple="true" data-selected="{{ form.secondary_colors.value|default:'' }}" :color_choices="{{ color_choices|safe }}">
              </c-color-selector>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-12" id="div_id_design">
              <c-design-selector name="design" label="{% trans 'Design Pattern' %}" data-selected="{{ form.design.value|default:'' }}" :design_choices="{{ design_choices|safe }}">
              </c-design-selector>
            </div>
          </div>
          <!-- Size and Condition in same row -->
          <div class="row mb-3">
            {% for field in form %}
              {% if field.name == 'size' %}
                <div class="col-md-6" id="div_id_size">{{ field|as_crispy_field }}</div>
              {% elif field.name == 'condition' %}
                <div class="col-md-6" id="div_id_condition">{{ field|as_crispy_field }}</div>
              {% endif %}
            {% endfor %}
          </div>
          <!-- Detailed condition and Country in same row -->
          <div class="row mb-3">
            {% for field in form %}
              {% if field.name == 'detailed_condition' %}
                <div class="col-md-6" id="div_id_detailed_condition">{{ field|as_crispy_field }}</div>
              {% elif field.name == 'country_code' %}
                <div class="col-md-6" id="div_id_country_code">{{ field|as_crispy_field }}</div>
              {% endif %}
            {% endfor %}
          </div>
          <!-- Renderizar el formulario excluyendo los campos que ya est√°n como componentes Cotton -->
          {% for field in form %}
            {% if field.name == 'brand' or field.name == 'club' or field.name == 'season' or field.name == 'competitions' %}
              <!-- These fields are now shown in the read-only info section above -->
              <div class="form-group" x-show="!kitData">{{ field|as_crispy_field }}</div>
            {% elif field.name == 'size' or field.name == 'condition' or field.name == 'detailed_condition' or field.name == 'country_code' %}
              <!-- These fields are already rendered above in their respective rows -->
            {% elif field.name == 'club_search' %}
              <!-- Hidden duplicate club search field -->
            {% elif field.name == 'is_fan_version' %}
              <!-- Hidden by JS; custom toggle above controls this -->
              <div class="d-none">{{ field|as_crispy_field }}</div>
            {% elif field.name == 'is_signed' or field.name == 'is_replica' %}
              <!-- Hidden; custom switches rendered near toggles -->
              <div class="d-none">{{ field|as_crispy_field }}</div>
            {% elif field.name == 'has_nameset' %}
              <!-- Hidden by JS; custom nameset UI below controls this -->
              <div class="d-none">{{ field|as_crispy_field }}</div>
            {% elif field.name == 'player_name' or field.name == 'number' %}
              <!-- Nameset fields: will be rendered below the button -->
            {% elif field.name == 'description' %}
              <!-- Description field -->
              <div id="div_id_description" class="mb-0">{{ field|as_crispy_field }}</div>
            {% elif field.name != 'main_color' and field.name != 'secondary_colors' and field.name != 'design' and field.name != 'size' and field.name != 'condition' and field.name != 'detailed_condition' and field.name != 'country_code' and field.name not in 'kit_search,kit_id,brand_name,brand_id,club_name,club_id,season_name,season_id,competition_name,competition_id,competition_names,main_img_url,external_image_urls' %}
              {{ field|as_crispy_field }}
            {% endif %}
          {% endfor %}
          <!-- Version Toggle: Fan vs Player (mutually exclusive) -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Jersey Version" %}</label>
              <div class="btn-group w-100 fc-btn-group" role="group" aria-label="Version toggle">
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="isFanVersion ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setVersion('fan')">{% trans "Fan Version" %}</button>
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="!isFanVersion ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setVersion('player')">{% trans "Player Version" %}</button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Sleeve Type" %}</label>
              <div class="btn-group w-100 fc-btn-group" role="group" aria-label="Sleeve toggle">
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="isShortSleeve ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setSleeve('short')">{% trans "Short Sleeve" %}</button>
                <button type="button"
                        class="btn fc-btn-group-item"
                        :class="!isShortSleeve ? 'btn-primary' : 'btn-outline-primary'"
                        @click="setSleeve('long')">{% trans "Long Sleeve" %}</button>
              </div>
            </div>
          </div>
          <!-- Binary options row (clear alignment) - Toggle switches -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Include Player Signature" %}</label>
              <label class="toggle-switch">
                <input type="checkbox" id="id_is_signed" name="is_signed" {% if form.is_signed.value %}checked{% endif %} />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="col-md-6">
              <label class="fc-form-label-block">{% trans "Is replica" %}</label>
              <label class="toggle-switch">
                <input type="checkbox" id="id_is_replica" name="is_replica" {% if form.is_replica.value %}checked{% endif %} />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <!-- Nameset toggle button and fields -->
          <div class="mb-3">
            <button type="button" class="btn btn-outline-secondary" x-show="!hasNameset" @click="enableNameset()">
              <i class="bi bi-person-badge"></i> Add Nameset
            </button>
            <button type="button" class="btn btn-outline-danger" x-show="hasNameset" @click="disableNameset()">
              <i class="bi bi-x-circle"></i> Remove Nameset
            </button>
          </div>
          <!-- Nameset fields in same row below button -->
          <div class="row mb-3" x-show="hasNameset" x-cloak>
            {% for field in form %}
              {% if field.name == 'player_name' %}
                <div class="col-md-6" id="div_id_player_name">{{ field|as_crispy_field }}</div>
              {% elif field.name == 'number' %}
                <div class="col-md-6" id="div_id_number">{{ field|as_crispy_field }}</div>
              {% endif %}
            {% endfor %}
          </div>
          <!-- Hidden fields for creating new entities -->
          {{ form.kit_id }}
          {{ form.brand_name }}
          {{ form.brand_id }}
          {{ form.club_name }}
          {{ form.club_id }}
          {{ form.season_name }}
          {{ form.season_id }}
          {{ form.competition_name }}
          {{ form.competition_id }}
          {{ form.competition_names }}
          {{ form.main_img_url }}
          {{ form.external_image_urls }}
        </div>
      </div>
      <!-- Photo Manager -->
      <div class="fc-card mb-4">
        <div class="fc-card-header-small">
          <h5 class="card-title mb-0 fc-title-small">{% trans "Photos" %}</h5>
        </div>
        <div class="fc-card-body-small fc-card-body-flex">
          <div class="mb-3">
            <button type="button" id="add-default-image" class="btn btn-outline-primary mb-3" onclick="addDefaultImageToPhotos()">
              <i class="bi bi-image"></i> {% trans "Add Default Image to Photos" %}
            </button>
          </div>
          <c-collection.photo_manager></c-collection.photo_manager>
        </div>
      </div>
      <div class="d-flex justify-content-end gap-3 mt-4">
        <button type="button" class="btn fc-btn-outline-secondary" onclick="verifyFormData()">
          {% trans "Verify Form Data" %}
        </button>
        <button type="submit" id="submit-jersey-btn" class="btn fc-btn-primary">
          <span id="submit-text">{% trans "Create Jersey" %}</span>
          <span id="submit-spinner" class="spinner-border spinner-border-sm ms-2 fc-d-none" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </form>
  </div>
  <script>
    // Function to verify form data before submitting
    function verifyFormData() {
      const form = document.getElementById('jersey-form');
      const formData = new FormData(form);

      console.log('Verifying form data:');

      // Check critical fields
      const criticalFields = ['brand', 'club', 'season', 'competition', 'brand_name', 'club_name', 'season_name', 'competition_name'];

      criticalFields.forEach(field => {
        const value = formData.get(field);
        console.log(`${field}: ${value || 'Not defined'}`);
      });

      // Check if we have enough information for each entity
      const hasValidBrand = formData.get('brand') || formData.get('brand_name');
      const hasValidClub = formData.get('club') || formData.get('club_name');
      const hasValidSeason = formData.get('season') || formData.get('season_name');
      const hasValidCompetition = formData.get('competition') || formData.get('competition_name');

      console.log('Entity validation:');
      console.log(`Brand: ${hasValidBrand ? 'OK' : 'Missing information'}`);
      console.log(`Club: ${hasValidClub ? 'OK' : 'Missing information'}`);
      console.log(`Season: ${hasValidSeason ? 'OK' : 'Missing information'}`);
      console.log(`Competition: ${hasValidCompetition ? 'OK' : 'Missing information'}`);

      // Show a message to the user
      if (hasValidBrand && hasValidClub && hasValidSeason && hasValidCompetition) {
        alert('Form data appears correct. You can proceed to create the jersey.');
      } else {
        alert('Important data is missing from the form. Please check the information in the console.');
      }
    }

    // Show loading spinner when form is submitted
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('jersey-form');
      const submitBtn = document.getElementById('submit-jersey-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');
      const creatingText = '{% trans "Creating..." %}';

      if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
          // Show spinner and disable button
          submitSpinner.style.display = 'inline-block';
          submitText.textContent = creatingText;
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.7';
          submitBtn.style.cursor = 'not-allowed';
        });
      }
    });
  </script>
{% endblock content %}
{% block extra_js %}
  {{ form.media.js }}
{% endblock extra_js %}

{% block content %}
  {% load static %}

  <div class="container py-5">
    <div class="dropzone-container p-4 border rounded">
      <form class="dropzone"
            id="demoDropzone"
            action="{% url 'collection:handle_dropzone_files' %}"
            data-delete-url="{% url 'collection:handle_dropzone_files' %}">
        {% csrf_token %}
        <div class="dz-message text-center">
          <i class="bi bi-cloud-upload fs-1 text-primary"></i>
          <h4 class="mt-3">Drag files here</h4>
          <p class="text-muted">or click to select</p>
        </div>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      new Dropzone("#demoDropzone", {
        paramName: "file",
        maxFilesize: 5, // 5MB
        acceptedFiles: 'image/*',
        addRemoveLinks: true,
        dictDefaultMessage: "",
        dictRemoveFile: "Remove",
        headers: {
          'X-CSRFToken': csrfToken
        },
        init: function() {
          this.on("success", function(file, response) {
            // Configure data for deletion
            file.previewElement.querySelector("[data-dz-name]").innerHTML = response.name;
            file._removeUrl = response.deleteUrl + '?fileName=' + encodeURIComponent(response.name);
          });

          this.on("error", function(file, message) {
            alert("Error: " + (message.error || message));
          });
        },
        // Configuration for deletion
        removedfile: function(file) {
          const deleteUrl = file._removeUrl;

          // Delete from the backend
          fetch(deleteUrl, {
              method: 'DELETE',
              headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                fileName: file.name
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Delete preview
                file.previewElement.remove();
              } else {
                alert('Error deleting file: ' + data.message);
              }
            })
            .catch(error => {
              alert('Error connecting to the server: ' + error.message);
            });
        }
      });
    });
  </script>
{% endblock content %}

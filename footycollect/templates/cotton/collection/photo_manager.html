{% load i18n static %}

<div class="photo-manager" x-data="photoManager({{ initial_photos|default:'[]'|safe }})"
     @dragover.prevent="isDragging = true"
     @dragleave.prevent="isDragging = false"
     @drop.prevent="handleDrop($event)"
     :class="{'dragover': isDragging}">

    <!-- Upload Area -->
    <div class="upload-area">
        <input type="file" multiple @change="addFiles($event)" 
               accept="image/jpeg,image/png,image/webp,image/gif"
               class="file-input">
        <div class="upload-message">
            <i class="bi bi-cloud-upload fs-1"></i>
            <p>{% trans "Drag files here or click to select" %}</p>
            <small class="text-muted">
                {% trans "Maximum 15MB per file. Supported formats: JPG, PNG, WebP, GIF" %}
            </small>
        </div>
    </div>

    <!-- Photo Grid -->
    <div class="photo-grid" x-show="photos.length > 0">
        <template x-for="(photo, index) in photos" :key="photo.id || index">
            <div class="photo-item" 
                 draggable="true"
                 @dragstart="dragStart(index)"
                 @dragover.prevent="dragOver(index)"
                 @dragend="dragEnd()"
                 @drop.prevent="drop(index)">
                
                <!-- Preview Image -->
                <img :src="photo.url || getFileURL(photo.file)" 
                     class="preview-image"
                     draggable="false"
                     @dragstart.prevent>
                
                <!-- Order Badge -->
                <span class="order-badge" x-text="index + 1"></span>
                
                <!-- Remove Button -->
                <button class="remove-btn" @click="removePhoto(index)" type="button">
                    <i class="bi bi-x" style="font-size: 1.2rem"></i>
                </button>
            </div>
        </template>
    </div>

    <!-- Hidden Input for Form Submission -->
    <input type="hidden" :name="inputName" :value="JSON.stringify(getPhotoData())">
</div>

<script>
function photoManager(initialPhotos = []) {
    return {
        photos: initialPhotos.map(photo => ({
            id: photo.id,
            url: photo.url,
            order: photo.order
        })),
        fileHashes: new Set(),
        isDragging: false,
        draggedIndex: null,
        inputName: 'photos_data',
        maxFiles: 10,
        maxFileSize: 15, // 15MB according to images.py
        acceptedTypes: ['image/jpeg', 'image/png', 'image/webp'],

        // Initialize component
        init() {
            // Calculate initial MD5 hashes
            this.photos.forEach(async photo => {
                if (photo.url) {
                    const response = await fetch(photo.url);
                    const blob = await response.blob();
                    const hash = await this.calculateHash(blob);
                    this.fileHashes.add(hash);
                }
            });

            const form = this.$el.closest('form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const formData = new FormData(form);
                        
                        // Limpiar formData de fotos anteriores
                        formData.delete('photos');
                        
                        // Agregar cada archivo
                        this.photos.forEach(photo => {
                            if (photo.file) {
                                console.log('Agregando archivo:', photo.file.name);
                                formData.append('photos', photo.file);
                            }
                        });

                        console.log('Enviando formulario...');
                        const response = await fetch(form.action, {
                            method: 'POST',
                            body: formData,
                        });

                        const result = await response.json();
                        
                        if (result.url) {
                            console.log('Redirigiendo a:', result.url);
                            // Asegurarse de que la URL es absoluta
                            const url = result.url.startsWith('/') ? result.url : '/' + result.url;
                            // Forzar la redirección
                            window.location = url;
                            return;
                        } else {
                            throw new Error(result.error || 'Error desconocido');
                        }
                    } catch (error) {
                        console.error('Error en el envío:', error);
                        alert('Error al enviar el formulario: ' + error.message);
                    }
                });
            }
        },

        // Handle file drops
        async handleDrop(e) {
            this.isDragging = false;
            const files = Array.from(e.dataTransfer.files);
            await this.processFiles(files);
        },

        // Handle file input changes
        async addFiles(e) {
            const files = Array.from(e.target.files);
            console.log('Archivos seleccionados:', files);
            await this.processFiles(files);
        },

        // Process new files with type validation
        async processFiles(files) {
            console.log('Procesando archivos:', files);
            
            if (this.photos.length + files.length > this.maxFiles) {
                alert(
                    `{% trans "Maximum number of photos is" %} ${this.maxFiles}`
                );
                return;
            }

            for (const file of files) {
                // Check file type
                if (!this.acceptedTypes.includes(file.type)) {
                    alert(
                        `{% trans "File" %} ${file.name} {% trans "is not a supported image format" %}`
                    );
                    continue;
                }

                // Check file size (15MB)
                if (file.size > this.maxFileSize * 1024 * 1024) {
                    alert(
                        `{% trans "File" %} ${file.name} {% trans "is too large. Maximum size is" %} ${this.maxFileSize}MB`
                    );
                    continue;
                }

                // Check for duplicates
                const hash = await this.calculateHash(file);
                if (this.fileHashes.has(hash)) {
                    alert(
                        `{% trans "File" %} ${file.name} {% trans "has already been added" %}`
                    );
                    continue;
                }

                this.fileHashes.add(hash);
                this.photos.push({
                    file: file,
                    order: this.photos.length
                });
            }
            
            console.log('Estado actual de photos:', this.photos);
        },

        // Handle drag and drop reordering
        dragStart(index) {
            this.draggedIndex = index;
        },

        dragOver(index) {
            if (this.draggedIndex === null) return;
            if (this.draggedIndex !== index) {
                this.reorderPhotos(this.draggedIndex, index);
                this.draggedIndex = index;
            }
        },

        dragEnd() {
            this.draggedIndex = null;
        },

        drop(index) {
            this.draggedIndex = null;
        },

        // Reorder photos array
        reorderPhotos(oldIndex, newIndex) {
            const photo = this.photos.splice(oldIndex, 1)[0];
            this.photos.splice(newIndex, 0, photo);
        },

        // Remove photo
        async removePhoto(index) {
            const photo = this.photos[index];
            if (photo.file) {
                const hash = await this.calculateHash(photo.file);
                this.fileHashes.delete(hash);
            }
            this.photos.splice(index, 1);
        },

        // Calculate MD5 hash
        async calculateHash(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                const spark = new SparkMD5.ArrayBuffer();
                
                reader.onload = (e) => {
                    spark.append(e.target.result);
                    resolve(spark.end());
                };
                
                reader.readAsArrayBuffer(file);
            });
        },

        // Get file URL for preview
        getFileURL(file) {
            return URL.createObjectURL(file);
        },

        // Get photo data for form submission
        getPhotoData() {
            return this.photos.map((photo, index) => ({
                id: photo.id || null,
                file: photo.file ? photo.file.name : null,
                order: index,
                isNew: !!photo.file  // Marcar si es un archivo nuevo
            }));
        }
    };
}
</script>

<style>
.photo-manager {
    border: 2px dashed #0d6efd;
    border-radius: 8px;
    padding: 20px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.photo-manager.dragover {
    background: #e9ecef;
    border-color: #0b5ed7;
}

.upload-area {
    text-align: center;
    padding: 40px 20px;
    position: relative;
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.photo-item {
    position: relative;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: move;
    transition: transform 0.2s ease;
}

.photo-item:hover {
    transform: translateY(-2px);
}

.preview-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    pointer-events: none;
    user-select: none;
    -webkit-user-drag: none;
}

.order-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(0,0,0,0.7);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #dc3545;
    transition: all 0.2s ease;
    line-height: 1;
}

.remove-btn:hover {
    background: #dc3545;
    color: white;
}

.remove-btn i {
    margin-top: -1px; /* Ajuste fino para centrar el ícono X */
}
</style> 
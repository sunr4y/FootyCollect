<c-vars name label required="false" api_endpoint help_text multiple="false" initial_data="{}" />
<div class="mb-3">
  <label for="id_{{ name }}" class="form-label">
    {% if label %}
      {{ label }}
    {% else %}
      {{ name|title }}
    {% endif %}
    {% if required == "true" or required == True %}*{% endif %}
  </label>
  {% if help_text %}
    <small class="form-text text-muted mb-2 d-block autocomplete-help-text">{{ help_text }}</small>
  {% endif %}
  <div class="position-relative"
       x-data="autocompleteSearch('{{ name }}', '{{ api_endpoint }}', '{{ multiple }}', {{ initial_data|default:'{}'|safe }})">
    <!-- Selected items display (multiple) -->
    <template x-if="isMultiple && selectedItems.length > 0">
      <div class="mb-2">
        <template x-for="item in selectedItems" :key="item.id">
          <div class="d-flex align-items-center border rounded p-2 mb-1 autocomplete-selected-item">
            <img x-show="item.logo_dark || item.logo" :src="item.logo_dark || item.logo" :alt="item.name" class="me-2 autocomplete-logo" />
            <span x-text="item.name" class="flex-grow-1 autocomplete-item-name"></span>
            <button type="button"
                    @click="removeItem(item.id)"
                    class="btn btn-sm btn-outline-danger ms-2 autocomplete-remove-btn"
                    title="Remove">
              <i class="bi bi-x-lg"></i> Remove
            </button>
          </div>
        </template>
      </div>
    </template>
    <!-- Selected item display (single) -->
    <div x-show="!isMultiple && selectedItem" x-cloak>
      <div class="d-flex align-items-center border rounded p-2 mb-2 autocomplete-selected-item autocomplete-selected-item-single">
        <img x-show="selectedItem && (selectedItem.logo_dark || selectedItem.logo)"
             :src="selectedItem ? (selectedItem.logo_dark || selectedItem.logo) : ''"
             :alt="selectedItem ? selectedItem.name : ''"
             class="me-2 autocomplete-logo" />
        <span x-text="selectedItem ? selectedItem.name : ''" class="flex-grow-1 autocomplete-item-name"></span>
        <button type="button"
                @click="clearSelection()"
                class="btn btn-sm btn-outline-danger ms-2 autocomplete-remove-btn"
                title="Remove selection">
          <i class="bi bi-x-lg"></i> Remove
        </button>
      </div>
    </div>
    <!-- Search input - HIDDEN when item selected in single mode -->
    <template x-if="isMultiple || selectedItem === null || selectedItem === undefined">
      <input type="text"
             class="form-control autocomplete-input"
             placeholder="Search..."
             x-model="searchQuery"
             @input.debounce.300ms="search()"
             @focus="showDropdown = true"
             @blur="setTimeout(() => showDropdown = false, 200)" />
    </template>
    <!-- Dropdown results - positioned right after input -->
    <div x-show="showDropdown && (results.length > 0 || (searchQuery.length >= 2 && !isSearching && results.length === 0))"
         class="position-absolute w-100 border rounded shadow-lg autocomplete-dropdown"
         x-cloak>
      <!-- Loading state -->
      <div x-show="isSearching" class="p-3 text-center autocomplete-loading">
        <span class="spinner-border spinner-border-sm me-2 autocomplete-spinner" role="status"></span>
        Searching...
      </div>
      <!-- Results -->
      <template x-if="!isSearching && results.length > 0">
        <div>
          <template x-for="item in results" :key="item.id">
            <div @mousedown.prevent="selectItem(item)"
                 class="p-2 border-bottom autocomplete-result-item"
                 @mouseenter="$el.classList.add('autocomplete-result-item-hover')"
                 @mouseleave="$el.classList.remove('autocomplete-result-item-hover')">
              <div class="d-flex align-items-center">
                <img x-show="item.logo_dark || item.logo" :src="item.logo_dark || item.logo" :alt="item.name" class="me-2 autocomplete-logo" />
                <span x-text="item.name" class="autocomplete-item-name"></span>
                <template x-if="!isMultiple && selectedItem && selectedItem.id === item.id">
                  <i class="bi bi-check-circle-fill ms-2 autocomplete-check-icon"></i>
                </template>
                <template x-if="isMultiple && selectedItems.find(i => i.id === item.id)">
                  <i class="bi bi-check-circle-fill ms-2 autocomplete-check-icon"></i>
                </template>
              </div>
            </div>
          </template>
        </div>
      </template>
      <!-- No results -->
      <div x-show="!isSearching && searchQuery.length >= 2 && results.length === 0"
           class="p-3 text-center autocomplete-no-results">
        <p class="mb-2">No results found</p>
        <button type="button" @click="createCustom()" class="btn btn-sm btn-primary autocomplete-create-btn">
          <i class="bi bi-plus-circle"></i> Create Custom
        </button>
      </div>
    </div>
    <!-- Hidden input for form submission -->
    <input type="hidden" name="{{ name }}" id="id_{{ name }}" :value="getHiddenValue()" />
    {% if name == "brand" %}
      <input type="hidden" name="brand_name" id="id_brand_name" :value="selectedItem ? selectedItem.name : ''" />
    {% elif name == "club" %}
      <input type="hidden" name="club_name" id="id_club_name" :value="selectedItem ? selectedItem.name : ''" />
    {% elif name == "season" %}
      <input type="hidden" name="season_name" id="id_season_name" :value="selectedItem ? selectedItem.name : ''" />
    {% elif name == "competitions" %}
      <input type="hidden" name="competition_name" id="id_competition_name" :value="selectedItems.map(i => i.name).join(',')" />
    {% endif %}
  </div>
</div>
<style>
  .autocomplete-help-text {
    color: var(--fc-muted-foreground);
  }

  .autocomplete-selected-item {
    background-color: var(--fc-secondary, #1a1f2b);
    border-color: var(--fc-border, #242c36) !important;
    color: var(--fc-foreground, #f0f0e8);
  }

  .autocomplete-selected-item-single {
    min-height: 38px;
  }

  .autocomplete-logo {
    width: 20px;
    height: 20px;
    object-fit: contain;
  }

  .autocomplete-item-name {
    color: var(--fc-foreground, #f0f0e8);
  }

  .autocomplete-remove-btn {
    border-color: var(--fc-border, #242c36);
    color: var(--fc-foreground, #f0f0e8);
  }

  .autocomplete-input {
    background-color: var(--fc-secondary) !important;
    border: 1px solid var(--fc-border) !important;
    color: var(--fc-foreground) !important;
  }

  .autocomplete-dropdown {
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    top: 100%;
    margin-top: 2px;
    background-color: var(--fc-card, #141820) !important;
    border-color: var(--fc-border, #242c36) !important;
    border-radius: 0.5rem;
    color: var(--fc-foreground, #f0f0e8) !important;
  }

  .autocomplete-loading {
    color: var(--fc-muted-foreground, #8b92a0);
  }

  .autocomplete-spinner {
    border-color: hsla(180, 85%, 40%, 0.3);
    border-right-color: hsla(180, 85%, 40%, 1);
  }

  .autocomplete-result-item {
    cursor: pointer;
    border-color: var(--fc-border, #242c36) !important;
    color: var(--fc-foreground, #f0f0e8) !important;
    background-color: var(--fc-card, #141820);
  }

  .autocomplete-result-item-hover {
    background-color: var(--fc-secondary, #1a1f2b) !important;
  }

  .autocomplete-check-icon {
    color: hsla(180, 85%, 40%, 1);
  }

  .autocomplete-no-results {
    color: var(--fc-muted-foreground, #8b92a0);
  }

  .autocomplete-create-btn {
    background-color: hsla(180, 85%, 40%, 1);
    border-color: hsla(180, 85%, 40%, 1);
  }
</style>
<script>
  document.addEventListener('alpine:init', () => {
    if (!Alpine.data('autocompleteSearch')) {
      Alpine.data('autocompleteSearch', (name, apiEndpoint, multiple = false, initialData = null) => {
        // Initialize with provided initial data if available
        let initialSelectedItem = null;
        let initialSelectedItems = [];
        let initialSelectedId = null;

        // Parse initialData if it's a string (JSON)
        let parsedData = initialData;
        if (typeof initialData === 'string') {
          try {
            parsedData = JSON.parse(initialData);
          } catch (e) {
            console.warn('Failed to parse initialData as JSON:', e);
            parsedData = null;
          }
        }

        if (parsedData && typeof parsedData === 'object' && parsedData[name]) {
          const data = parsedData[name];
          if (Array.isArray(data)) {
            initialSelectedItems = data;
          } else if (data && data.id) {
            initialSelectedItem = data;
            initialSelectedId = data.id;
          }
        }

        return {
          searchQuery: '',
          results: [],
          selectedItem: initialSelectedItem,
          selectedItems: initialSelectedItems,
          selectedId: initialSelectedId,
          isSearching: false,
          showDropdown: false,
          isMultiple: multiple === true || multiple === 'true',
          fieldName: name,
          apiEndpoint: apiEndpoint,

          search() {
            if (this.searchQuery.length < 2) {
              this.results = [];
              return;
            }

            this.isSearching = true;
            this.showDropdown = true;

            const url = `/fkapi/${this.apiEndpoint}/search/?keyword=${encodeURIComponent(this.searchQuery)}`;

            fetch(url)
              .then(response => response.json())
              .then(data => {
                this.results = data.results || [];
                this.isSearching = false;
              })
              .catch(error => {
                console.error('Error searching:', error);
                this.results = [];
                this.isSearching = false;
              });
          },

          selectItem(item) {
            if (this.isMultiple) {
              if (!this.selectedItems.find(i => i.id === item.id)) {
                this.selectedItems.push(item);
                this.searchQuery = '';
                this.results = [];
                this.showDropdown = false;
              }
            } else {
              this.selectedItem = Object.assign({}, item);
              this.selectedId = item.id;
              this.selectedItems = [];
              this.searchQuery = '';
              this.results = [];
              this.showDropdown = false;
            }
          },

          clearSelection() {
            this.selectedItem = null;
            this.selectedId = null;
            this.selectedItems = [];
            this.searchQuery = '';
            this.results = [];
          },

          removeItem(itemId) {
            this.selectedItems = this.selectedItems.filter(item => item.id !== itemId);
          },

          getHiddenValue() {
            if (this.isMultiple) {
              return this.selectedItems.map(item => item.id).join(',');
            }
            return this.selectedId || '';
          },

          createCustom() {
            if (!this.searchQuery || this.searchQuery.trim().length === 0) {
              alert('Please enter a name');
              return;
            }

            const customName = this.searchQuery.trim();
            const nameField = document.getElementById(`id_${this.fieldName}_name`);
            if (nameField) {
              nameField.value = customName;
            }

            if (this.isMultiple) {
              this.selectedItems.push({
                id: null,
                name: customName,
                logo: null
              });
            } else {
              this.selectedItem = {
                id: null,
                name: customName,
                logo: null
              };
            }

            this.searchQuery = '';
            this.results = [];
            this.showDropdown = false;

            alert(`Custom item "${customName}" will be created when you submit the form`);
          }
        };
      });
    }
  });
</script>
